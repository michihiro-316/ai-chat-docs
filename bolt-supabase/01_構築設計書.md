# 01. 構築設計書（Bolt + Supabase版）

| 項目 | 内容 |
|------|------|
| 作成日 | 2025年12月 |
| バージョン | 1.0 |
| 対象 | AIチーム |

---

## 1. システム概要

### 1.1 目的

非エンジニアチームがDify、Vertex AI等のAIツールを安全に運用し、外部顧客にもサービスを提供できる環境を構築する。

### 1.2 要件

| 要件 | 内容 |
|------|------|
| 運用アプリ | Dify、Vertex AI + 将来的に他AIツール追加 |
| 利用者 | 社内メンバー + 外部顧客（500人規模想定） |
| 認証方式 | Googleログイン（OAuth 2.0） |
| 個人情報 | 扱わない |
| 構築方法 | Bolt.new + Supabaseコンソールで設定 |
| 担当者スキル | 非エンジニア |
| コード管理 | GitHubで管理（Bolt連携） |

### 1.3 採用構成

**Bolt + Supabase サーバーレス構成**

> **Bolt.new とは**
>
> AIがコードを自動生成してくれるノーコード/ローコード開発ツールです。
> 「チャットアプリを作って」と指示するだけで、動くアプリが生成されます。
>
> **Supabase とは**
>
> 「Firebaseのオープンソース代替」と呼ばれるBaaS（Backend as a Service）です。
> 認証、データベース、ストレージ、Edge Functionsが1つのダッシュボードで管理できます。

※ 非エンジニアでも構築可能な最もシンプルな構成を採用

---

## 2. アーキテクチャ

### 2.1 全体構成図

```
                              ┌─────────────────┐
                              │     ユーザー      │
                              │   （ブラウザ）     │
                              └────────┬────────┘
                                       │
                                       │ HTTPS
                                       │
              ┌────────────────────────┼────────────────────────┐
              │                        │                        │
              ▼                        ▼                        ▼
    companya.example     companyb.example     companyc.example
         .co.jp                  .co.jp                  .co.jp
              │                        │                        │
              ▼                        ▼                        ▼
   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
   │     Vercel      │    │     Vercel      │    │     Vercel      │
   │  (フロントエンド) │    │  (フロントエンド) │    │  (フロントエンド) │
   └────────┬────────┘    └────────┬────────┘    └────────┬────────┘
            │                      │                      │
            ▼                      ▼                      ▼
   ┌─────────────────────────────────────────────────────────────┐
   │                     Supabase                                │
   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
   │  │    Auth     │  │  Database   │  │Edge Functions│         │
   │  │  (認証)     │  │ (PostgreSQL)│  │ (バックエンド)│         │
   │  └─────────────┘  └─────────────┘  └──────┬──────┘         │
   │                                           │                 │
   │  ┌─────────────┐                          │                 │
   │  │   Vault     │◄─────────────────────────┘                 │
   │  │ (シークレット)│                                           │
   │  └─────────────┘                                            │
   └─────────────────────────────────────────────────────────────┘
```

### 2.2 構成のポイント

| ポイント | 説明 |
|----------|------|
| ワンストップ | 認証・DB・バックエンド・シークレットが1つのダッシュボード |
| Bolt連携 | AIが自動でコード生成、Supabase連携も自動設定 |
| 自動デプロイ | GitHubにプッシュ → Vercelが自動デプロイ |
| 自動SSL | Vercelがカスタムドメインに自動でSSL発行 |
| 低コスト | 無料枠が充実、小規模なら$0で運用可能 |

---

## 3. コンポーネント設計

### 3.1 Supabase Auth

| 項目 | 設定値 |
|------|--------|
| 役割 | 全テナント共通のユーザー認証 |
| 認証方式 | Googleログイン（OAuth 2.0） |
| ユーザー管理 | Supabaseダッシュボードで一元管理 |
| セッション | 自動管理（JWTトークン） |

### 3.2 Supabase Edge Functions

| 項目 | 設定値 |
|------|--------|
| 役割 | バックエンドAPI（AI呼び出し等） |
| ランタイム | Deno（TypeScript） |
| デプロイ | CLIまたはダッシュボードから |
| タイムアウト | 150秒（無料プラン） |
| 認証 | Supabase Authと自動連携 |

### 3.3 Supabase Vault

| 項目 | 設定値 |
|------|--------|
| 役割 | APIキー・機密情報の保管 |
| 暗号化 | AES-256-GCM |
| アクセス | Edge Functionsから参照 |

### 3.4 Vercel（フロントエンド）

| 項目 | 設定値 |
|------|--------|
| 役割 | フロントエンド配信 |
| フレームワーク | React / Next.js（Boltが自動選択） |
| デプロイ | GitHub連携で自動 |
| CDN | グローバルエッジネットワーク |

---

## 4. セキュリティ設計

### 4.1 多層防御アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    第1層: HTTPS通信                          │
│                   （全通信の暗号化）                          │
│  - TLS 1.3                                                  │
│  - Vercel / Supabase 自動SSL                                │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                第2層: Supabase Auth                         │
│                   （ユーザー認証）                            │
│  - Googleログイン必須                                        │
│  - Row Level Security（RLS）でデータアクセス制御              │
│  - JWTトークンで認証状態管理                                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│               第3層: Supabase Vault                         │
│                （機密情報の保護）                              │
│  - APIキーはコードに含めない                                  │
│  - AES-256-GCM暗号化保存                                     │
│  - Edge Functionsからのみアクセス可能                         │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 Row Level Security（RLS）

Supabaseの強力な機能。ユーザーごとにデータアクセスを自動制限。

```sql
-- 例: ユーザーは自分のデータのみアクセス可能
CREATE POLICY "Users can only see their own data"
ON chat_history
FOR SELECT
USING (auth.uid() = user_id);
```

---

## 5. コスト設計

### 5.1 月額費用見積もり

#### Supabase（無料プラン）

| リソース | 無料枠 |
|----------|--------|
| データベース | 500MB |
| ストレージ | 1GB |
| Edge Functions | 500,000回/月 |
| 認証ユーザー | 50,000 MAU |
| Vault | 無制限 |

#### Vercel（無料プラン）

| リソース | 無料枠 |
|----------|--------|
| 帯域幅 | 100GB/月 |
| ビルド時間 | 6,000分/月 |
| サーバーレス関数 | 100GB-時間/月 |

#### 総コスト見積もり

| テナント数 | 月額目安 | 備考 |
|------------|----------|------|
| 1テナント | **$0** | 無料枠内で運用可能 |
| 3テナント | **$0〜25** | Supabase Pro検討 |
| 5テナント | **$25〜50** | Supabase Pro |

> **重要: AI API利用料金は別途発生**
>
> 上記はインフラ費用のみです。OpenAI、Anthropic等のAI API利用料金は別途発生します。

---

## 6. GCP版との比較

| 項目 | Bolt + Supabase | GCP + Firebase |
|------|-----------------|----------------|
| 構築時間 | **30分〜1時間** | 1〜2時間 |
| 管理画面 | **1つ（Supabase）** | 2つ（GCP + Firebase） |
| 学習コスト | **低い** | やや高い |
| 月額費用（小規模） | **$0** | $5〜30 |
| スケーラビリティ | 中規模まで | 大規模対応 |
| エンタープライズ | △ | ◎ |
| Google Workspace連携 | △ | ◎ |

### 推奨選択

| ケース | 推奨 |
|--------|------|
| 非エンジニアが構築 | **Bolt + Supabase** |
| 小〜中規模（〜1000人） | **Bolt + Supabase** |
| 大規模・エンタープライズ | GCP + Firebase |
| Google Workspace連携必須 | GCP + Firebase |

---

## 7. 可用性・スケーラビリティ

### 7.1 可用性

| サービス | SLA |
|----------|-----|
| Supabase | 99.9%（Pro以上） |
| Vercel | 99.99% |

### 7.2 スケーラビリティ

| 項目 | 制限 |
|------|------|
| 同時接続 | 無料: 200 / Pro: 500 |
| Edge Functions | 自動スケール |
| データベース | 無料: 500MB / Pro: 8GB〜 |

---

## 8. 今後の拡張

### 8.1 有料プランへのアップグレード

| プラン | 月額 | 主な追加機能 |
|--------|------|--------------|
| Supabase Pro | $25 | 8GB DB、毎日バックアップ、SLA |
| Vercel Pro | $20 | 1TB帯域、チーム機能 |

### 8.2 追加可能な機能

| 機能 | 方法 |
|------|------|
| リアルタイム機能 | Supabase Realtime（標準搭載） |
| ファイルアップロード | Supabase Storage（標準搭載） |
| 定期実行 | Supabase Cron（Pro以上） |
