# AIチーム向け GCP環境 構築設計書

| 項目 | 内容 |
|------|------|
| 作成日 | 2025年12月19日 |
| バージョン | 1.0 |
| 対象 | AIチーム |

---

## 1. システム概要

### 1.1 目的
非エンジニアチームがDify、Vertex AI等のAIツールを安全に運用し、外部顧客にもサービスを提供できる環境を構築する。

### 1.2 要件

| 要件 | 内容 |
|------|------|
| 運用アプリ | Dify、Vertex AI + 将来的に他AIツール追加 |
| 利用者 | 社内メンバー + 外部顧客（500人規模想定） |
| 認証方式 | Googleログイン（OAuth 2.0） |
| 個人情報 | 扱わない |
| 構築方法 | GCPコンソールで手動設定 |
| 担当者スキル | 非エンジニア |
| コード管理 | GitHubで管理 |

### 1.3 採用構成
**Cloud Run functions サブドメイン方式マルチテナント構成**

> **Cloud Run functions とは**
> 2024年8月、Cloud FunctionsはCloud Runに統合され「Cloud Run functions」に名称変更されました。
> コードを直接入力するだけでデプロイでき、Dockerイメージは不要です。
> GCPコンソールでは「Cloud Run」→「関数を作成」から利用します。

※ 非エンジニアでも構築可能なシンプル構成を採用

---

## 2. アーキテクチャ

### 2.1 全体構成図

```
                              ┌─────────────────┐
                              │     ユーザー      │
                              │   （ブラウザ）     │
                              └────────┬────────┘
                                       │
                                       │ HTTPS
                                       │
              ┌────────────────────────┼────────────────────────┐
              │                        │                        │
              ▼                        ▼                        ▼
    companya.anddigital     companyb.anddigital     companyc.anddigital
         .co.jp                  .co.jp                  .co.jp
              │                        │                        │
              │ DNS (CNAME)            │ DNS (CNAME)            │ DNS (CNAME)
              ▼                        ▼                        ▼
   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
   │ Cloud Run       │    │ Cloud Run       │    │ Cloud Run       │
   │ functions       │    │ functions       │    │ functions       │
   │ (tenant-a)      │    │ (tenant-b)      │    │ (tenant-c)      │
   │                 │    │                 │    │                 │
   │ - Dify          │    │ - Vertex AI     │    │ - カスタムAI     │
   │ - Firebase Auth │    │ - Firebase Auth │    │ - Firebase Auth │
   │ - 自動SSL証明書  │    │ - 自動SSL証明書  │    │ - 自動SSL証明書  │
   └────────┬────────┘    └────────┬────────┘    └────────┬────────┘
            │                      │                      │
            ▼                      ▼                      ▼
   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
   │ Secret Manager  │    │ Secret Manager  │    │ Secret Manager  │
   │  tenant-a-*     │    │  tenant-b-*     │    │  tenant-c-*     │
   └─────────────────┘    └─────────────────┘    └─────────────────┘
            │                      │                      │
            └──────────────────────┼──────────────────────┘
                                   │
                                   ▼
                          ┌──────────────┐
                          │    GitHub    │
                          │ （コード管理）  │
                          └──────────────┘
```

**構成のポイント:**
- **シンプル構成**: Load Balancer不要、Cloud Run functionsに直接マッピング
- **Docker不要**: コードを直接入力するだけでデプロイ可能
- **テナント分離**: 顧客ごとに独立した関数 + サブドメイン
- **データ分離**: Secret Managerをテナント別に分離
- **自動SSL**: Cloud Runのカスタムドメイン機能で自動発行・更新
- **低コスト**: Load Balancer費用（月$18〜25）が不要

### 2.2 サブドメインルーティング

```
ベースドメイン: anddigital.co.jp

【URL設計】
{tenant}.anddigital.co.jp/        → テナント専用トップページ
{tenant}.anddigital.co.jp/dify/*  → テナント専用 Difyアプリ
{tenant}.anddigital.co.jp/chat/*  → テナント専用 AIチャットボット
{tenant}.anddigital.co.jp/vertex/* → テナント専用 Vertex AIアプリ

【テナント例】
companya.anddigital.co.jp/        → A社専用トップページ
companya.anddigital.co.jp/dify/*  → A社 Difyアプリ
companyb.anddigital.co.jp/        → B社専用トップページ
companyb.anddigital.co.jp/vertex/* → B社 Vertex AIアプリ
```

**DNS設定（テナント追加時）:**
| サブドメイン | レコードタイプ | 値 |
|-------------|---------------|-----|
| companya.anddigital.co.jp | CNAME | Cloud Run サービスURL |
| companyb.anddigital.co.jp | CNAME | Cloud Run サービスURL |

※ Cloud Runの「カスタムドメインをマッピング」機能を使用

### 2.3 データフロー

```
【認証フロー】

1. ユーザーが https://companya.anddigital.co.jp/ にアクセス
   │
   ▼
2. DNS が Cloud Run functions (tenant-a) に解決
   │
   ▼
3. Cloud Run functions が Firebase Auth の認証状態をチェック
   │
   ├── 未ログイン → Googleログイン画面にリダイレクト
   │                 │
   │                 ▼
   │            Googleアカウントでログイン
   │                 │
   │                 ▼
   │            Firebase ID Token 発行
   │
   └── ログイン済み → トークン検証
       │
       ├── 有効 + 許可ドメイン → 次のステップへ
       │
       └── 無効 or 許可外 → 403 アクセス拒否
   │
   ▼
5. アプリ画面を表示
```

```
【AI機能利用フロー】

1. ユーザーがAI機能を利用（ボタンクリック等）
   │
   ▼
2. Cloud Run functions がリクエストを処理
   │
   ▼
3. Secret Manager から該当テナントのAPIキーを取得
   （例: tenant-a-openai-key）
   │
   ▼
4. 外部AI API（OpenAI、Anthropic、Vertex AI等）を呼び出し
   │
   ▼
5. 結果をユーザーに返却
```

---

## 3. コンポーネント設計

### 3.1 Firebase Authentication

| 項目 | 設定値 |
|------|--------|
| 役割 | 全テナント共通のユーザー認証 |
| 認証方式 | Googleログイン（OAuth 2.0） |
| ユーザータイプ | 外部（External） |
| テナント識別 | カスタムクレーム or ユーザーのメールドメイン |
| ドメイン制限 | テナントごとに許可ドメインを設定可能 |

### 3.2 Cloud Run functions

| 項目 | 設定値 |
|------|--------|
| 役割 | バックエンドAPI + フロントエンド配信 |
| デプロイ単位 | **テナントごとに関数を作成** |
| 関数名規則 | `ai-platform-{tenant-id}` |
| リージョン | asia-northeast1（東京） |
| ランタイム | Node.js 20 / Python 3.11 |
| メモリ | 512MB〜2GB |
| 最小インスタンス | 0（コスト削減） |
| 最大インスタンス | 10（制限可能） |
| タイムアウト | 300秒 |
| 認証 | 未認証許可（Firebase Auth で制御） |
| カスタムドメイン | `{tenant}.anddigital.co.jp` をマッピング |

**デプロイ方法:**
- GCPコンソールの Cloud Run →「関数を作成」からコードを直接入力
- Dockerイメージは不要
- SSL証明書は自動発行・自動更新

### 3.3 Secret Manager

| 項目 | 設定値 |
|------|--------|
| 役割 | APIキー・機密情報の保管 |
| 命名規則 | `{tenant-id}-{secret-name}` |
| 例 | `companya-openai-key`, `companyb-anthropic-key` |
| 暗号化 | 自動（AES-256） |
| アクセス制御 | **テナント専用サービスアカウントのみアクセス可能** |
| バージョン管理 | 有効 |

**アクセス制御:**
Cloud Run functionsは、関数作成時にシークレットを環境変数として紐付けます。
GCPコンソールの「セキュリティ」→「シークレットを参照」から設定します。

### 3.4 Googleグループ（テナント管理用）

| 項目 | 設定値 |
|------|--------|
| 役割 | テナントごとのユーザー一括管理 |
| グループ例 | `ai-users-companya@anddigital.co.jp` |
| 管理方法 | Google Workspace 管理コンソール or groups.google.com |
| 用途 | Firebase Auth の許可ユーザー管理に使用 |

---

## 4. セキュリティ設計

### 4.1 多層防御アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    第1層: HTTPS通信                          │
│                   （全通信の暗号化）                          │
│                                                             │
│  - TLS 1.2以上                                               │
│  - Cloud Run 自動SSL証明書                                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              第2層: Firebase Authentication                  │
│                   （ユーザー認証）                            │
│                                                             │
│  - Googleログイン必須                                        │
│  - 未認証ユーザーはログイン画面にリダイレクト                   │
│  - テナントごとの許可ドメイン/ユーザー制御                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│               第3層: テナント分離                              │
│              （データ・リソース分離）                          │
│                                                             │
│  - Cloud Run functions: テナントごとに独立した関数             │
│  - Secret Manager: テナント別にシークレット管理                │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│               第4層: Secret Manager                          │
│                （機密情報の保護）                              │
│                                                             │
│  - APIキーはコードに含めない                                  │
│  - AES-256暗号化保存                                         │
│  - アクセスログ記録                                          │
└─────────────────────────────────────────────────────────────┘
```

**注意:** WAF（Cloud Armor）は本構成では使用しません。将来的にセキュリティ強化が必要な場合は Load Balancer + Cloud Armor の追加を検討してください。

### 4.2 テナント分離セキュリティ

```
【テナント分離の仕組み】

┌─────────────────────────────────────────────────────────────┐
│              サブドメイン分離                                  │
│                                                             │
│  - テナントごとに独立したサブドメイン + Cloud Run functions     │
│  - companya.anddigital.co.jp → tenant-a 関数のみアクセス      │
│  - companyb.anddigital.co.jp → tenant-b 関数のみアクセス      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              シークレット分離                                  │
│                                                             │
│  - テナントごとにシークレットを分離                            │
│  - tenant-a 関数 → tenant-a-* のシークレットのみ紐付け        │
│  - tenant-b 関数 → tenant-b-* のシークレットのみ紐付け        │
│  - 他テナントのシークレットは参照不可                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              アプリケーション認証                              │
│                                                             │
│  - Firebase Auth でユーザー認証                               │
│  - テナントごとの許可ユーザーリスト/ドメインで制御              │
│  - 異なるテナントへのアクセスは403拒否                         │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 アクセス制御マトリクス

| リソース | 未認証ユーザー | 認証済み（他テナント） | 認証済み（該当テナント） |
|---------|--------------|---------------------|----------------------|
| Cloud Run functions（テナントA） | 拒否 | 拒否 | 許可 |
| Cloud Run functions（テナントB） | 拒否 | 拒否 | 許可 |
| Secret Manager（tenant-a-*） | 拒否 | 拒否 | 許可（関数から参照） |
| Secret Manager（tenant-b-*） | 拒否 | 拒否 | 許可（関数から参照） |
| GCPコンソール | 拒否 | 拒否 | 管理者のみ |

### 4.4 通信セキュリティ

| 項目 | 設定 |
|------|------|
| プロトコル | HTTPS（TLS 1.2以上） |
| 証明書 | Google管理（自動発行・更新） |
| HTTP → HTTPS | 自動リダイレクト |

---

## 5. ネットワーク構成

### 5.1 インターネット接続

```
                         インターネット
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
   companya.           companyb.            companyc.
   anddigital.co.jp    anddigital.co.jp     anddigital.co.jp
        │                     │                     │
        │ DNS (CNAME)         │ DNS (CNAME)         │ DNS (CNAME)
        │ + HTTPS (443)       │ + HTTPS (443)       │ + HTTPS (443)
        ▼                     ▼                     ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ Cloud Run       │  │ Cloud Run       │  │ Cloud Run       │
│ functions       │  │ functions       │  │ functions       │
│ (tenant-a)      │  │ (tenant-b)      │  │ (tenant-c)      │
│ asia-northeast1 │  │ asia-northeast1 │  │ asia-northeast1 │
└─────────────────┘  └─────────────────┘  └─────────────────┘
```

### 5.2 リージョン設定

| サービス | リージョン | 理由 |
|---------|-----------|------|
| Cloud Run functions | asia-northeast1（東京） | 日本のユーザー向けレイテンシ最小化 |
| Secret Manager | asia-northeast1 | Cloud Run functionsと同一リージョン |
| Firebase Auth | グローバル | Google管理 |

---

## 6. 可用性・スケーラビリティ

### 6.1 可用性

| サービス | SLA | 冗長性 |
|---------|-----|--------|
| Cloud Run functions | 99.95% | 複数ゾーン |
| Firebase Auth | 99.95% | Google管理 |
| Secret Manager | 99.95% | リージョン内冗長 |

### 6.2 スケーラビリティ

| サービス | スケーリング | 制限 |
|---------|-------------|------|
| Cloud Run functions | 自動（0〜100インスタンス/関数） | テナントごとに設定可能 |
| テナント追加 | 手動 | 関数作成 + DNS設定 |

---

## 7. 監視・ログ

### 7.1 監視項目

| 項目 | ツール | アラート |
|------|--------|---------|
| サービス稼働状況 | Cloud Monitoring | ダウン時に通知 |
| エラー率 | Cloud Logging | 5%超過で通知 |
| レイテンシ | Cloud Monitoring | 3秒超過で通知 |
| コスト | Billing アラート | 予算超過で通知 |

### 7.2 ログ

| ログ種別 | 保存先 | 保持期間 |
|---------|--------|---------|
| アクセスログ | Cloud Logging | 30日 |
| エラーログ | Cloud Logging | 30日 |
| 認証ログ | Cloud Logging | 30日 |
| 監査ログ | Cloud Audit Logs | 400日 |

---

## 8. バックアップ・復旧

### 8.1 バックアップ対象

| 対象 | 方法 | 頻度 |
|------|------|------|
| 関数コード | GitHub | 変更のたびに自動 |
| Cloud Run functions設定 | GCP設定エクスポート | 月1回推奨 |
| Secret Manager | バージョン履歴 | 自動 |

### 8.2 復旧手順

| シナリオ | 復旧方法 | 目標復旧時間 |
|---------|---------|-------------|
| 関数障害 | GitHubから再デプロイ | 5分 |
| Cloud Run functions障害 | 関数再作成 | 15分 |
| 設定ミス | 以前のバージョンに戻す | 10分 |

---

## 9. コスト設計

### 9.1 月額費用見積もり（サブドメイン方式）

**基本インフラコスト（テナント数に関係なく固定）:**
| サービス | 月額目安 | 備考 |
|---------|---------|------|
| Firebase Auth | $0 | 月5万認証まで無料 |
| Cloud Logging | $0〜5 | 50GB/月まで無料 |
| **基本インフラ小計** | **$0〜5/月** | |

**テナントごとの追加コスト:**
| サービス | 月額目安/テナント | 備考 |
|---------|-----------------|------|
| Cloud Run functions | $5〜30 | リクエスト数・利用量に応じて |
| Secret Manager | 〜$1 | シークレット数に応じて |
| カスタムドメイン | $0 | Cloud Run機能で無料 |
| **テナント小計** | **$5〜31/テナント** | |

**総コスト見積もり:**
| テナント数 | 月額目安 | 旧構成との比較 |
|-----------|---------|---------------|
| 1テナント | $5〜36 | 約$23節約 |
| 3テナント | $15〜98 | 約$23節約 |
| 5テナント | $25〜160 | 約$23節約 |
| 10テナント | $50〜315 | 約$23節約 |

※ Load Balancer + Cloud Armor を使用しないため、月$23〜35のコスト削減

### 9.2 コスト最適化

- Cloud Run functionsの最小インスタンス数を0に設定（コールドスタート許容時）
- テナントごとの利用量に応じた設定調整
- 不要なログの削除
- 予算アラートの設定（テナントごと + 全体）

---

## 10. マルチテナント運用

### 10.1 テナントオンボーディング手順

| 手順 | 作業内容 | ツール | 難易度 |
|------|---------|--------|--------|
| 1 | Cloud Run functions 関数作成 | GCPコンソール | 簡単 |
| 2 | Secret Manager にAPIキー登録 | GCPコンソール | 簡単 |
| 3 | 関数にシークレットを紐付け | GCPコンソール | 簡単 |
| 4 | カスタムドメインをマッピング | GCPコンソール | 簡単 |
| 5 | DNSにCNAMEレコード追加 | DNS管理画面 | 簡単 |
| 6 | Firebase Auth で許可設定 | Firebase コンソール | 簡単 |
| 7 | 動作確認 | ブラウザ | 簡単 |

**ポイント:** Docker不要、コードを直接入力するだけなので非エンジニアでも対応可能

### 10.2 テナント追加の詳細手順（GCPコンソール）

**手順1: Cloud Run functions 関数作成**
1. GCPコンソール → Cloud Run →「関数を作成」
2. 関数名: `ai-platform-{tenant}`（例: ai-platform-companya）
3. リージョン: asia-northeast1（東京）
4. 認証: 「未認証の呼び出しを許可」にチェック
5. ランタイム: Node.js 20 または Python 3.11 を選択
6. コードを入力して「デプロイ」

**手順2: Secret Manager 設定**
1. GCPコンソール → Secret Manager →「シークレットを作成」
2. 名前: `{tenant}-openai-key`（例: companya-openai-key）
3. シークレット値: APIキーを入力
4.「作成」をクリック

**手順3: 関数にシークレットを紐付け**
1. 作成した関数 →「編集してデプロイ」
2.「セキュリティ」→「シークレットを参照」
3. 環境変数名とシークレットを設定
4.「デプロイ」

**手順4: カスタムドメインをマッピング**
1. 作成した関数を開く
2.「カスタムドメインをマッピング」をクリック
3. ドメイン: `{tenant}.anddigital.co.jp` を入力
4. 表示されるCNAMEレコード情報をメモ

**手順5: DNS設定**
1. ドメイン管理画面（お名前.com等）を開く
2. CNAMEレコードを追加:
   - ホスト名: `{tenant}`（例: companya）
   - 値: Cloud Runが表示したCNAME先
3. 反映まで数分〜数時間待つ

### 10.3 テナント管理台帳（スプレッドシート例）

| テナントID | 会社名 | サブドメイン | 関数名 | 許可ドメイン | 利用AI | 契約開始日 | ステータス |
|-----------|-------|-------------|--------|------------|--------|-----------|-----------|
| tenant-a | A株式会社 | companya.anddigital.co.jp | ai-platform-tenant-a | @a-company.co.jp | Dify | 2025/01/01 | 稼働中 |
| tenant-b | B株式会社 | companyb.anddigital.co.jp | ai-platform-tenant-b | @b-company.co.jp | Vertex AI | 2025/02/01 | 稼働中 |

---

## 11. 今後の拡張

### 11.1 追加可能な機能

| 機能 | サービス | 用途 | 優先度 |
|------|---------|------|--------|
| データベース | Cloud SQL / Firestore | ユーザーデータ・履歴の永続化 | 高 |
| ファイル保存 | Cloud Storage | 大容量ファイルアップロード | 中 |
| CI/CD | Cloud Build | テナント追加の自動化 | 中 |
| 監視ダッシュボード | Cloud Monitoring | テナント別の利用状況可視化 | 低 |

### 11.2 セキュリティ強化オプション

| 状況 | 対応策 | 追加コスト |
|------|--------|-----------|
| WAF/DDoS保護が必要 | Load Balancer + Cloud Armor を追加 | 月$23〜35 |
| より厳格なアクセス制御 | IAP（Identity-Aware Proxy）を追加 | 月$0〜5 |

### 11.3 スケールアップ時の考慮事項

| 状況 | 対応策 |
|------|--------|
| テナント数が50以上に増加 | Terraform等でのIaC化を検討 |
| 特定テナントの高負荷 | 関数のリソース増強 |
| グローバル展開 | 複数リージョンへの展開 |
| コンプライアンス要件強化 | GCPプロジェクト分離への移行 |
