
<!doctype html>
<html lang="ja" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="非エンジニア向けのAIチャットアプリ構築手順書">
      
      
      
      
        <link rel="prev" href="../01_design/">
      
      
        <link rel="next" href="../03_deploy_cost/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>構築手順書 - AIチャットアプリ構築ガイド</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+JP:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Noto Sans JP";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#gcp" class="md-skip">
          コンテンツにスキップ
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="ヘッダー">
    <a href="../.." title="AIチャットアプリ構築ガイド" class="md-header__button md-logo" aria-label="AIチャットアプリ構築ガイド" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 21.5c-1.35-.85-3.8-1.5-5.5-1.5-1.65 0-3.35.3-4.75 1.05-.1.05-.15.05-.25.05-.25 0-.5-.25-.5-.5V6c.6-.45 1.25-.75 2-1 1.11-.35 2.33-.5 3.5-.5 1.95 0 4.05.4 5.5 1.5 1.45-1.1 3.55-1.5 5.5-1.5 1.17 0 2.39.15 3.5.5.75.25 1.4.55 2 1v14.6c0 .25-.25.5-.5.5-.1 0-.15 0-.25-.05-1.4-.75-3.1-1.05-4.75-1.05-1.7 0-4.15.65-5.5 1.5M12 8v11.5c1.35-.85 3.8-1.5 5.5-1.5 1.2 0 2.4.15 3.5.5V7c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5m1 3.5c1.11-.68 2.6-1 4.5-1 .91 0 1.76.09 2.5.28V9.23c-.87-.15-1.71-.23-2.5-.23q-2.655 0-4.5.84zm4.5.17c-1.71 0-3.21.26-4.5.79v1.69c1.11-.65 2.6-.99 4.5-.99 1.04 0 1.88.08 2.5.24v-1.5c-.87-.16-1.71-.23-2.5-.23m2.5 2.9c-.87-.16-1.71-.24-2.5-.24-1.83 0-3.33.27-4.5.8v1.69c1.11-.66 2.6-.99 4.5-.99 1.04 0 1.88.08 2.5.24z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AIチャットアプリ構築ガイド
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              構築手順書
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="blue"  aria-label="ダークモードに切替"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="ダークモードに切替" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="grey" data-md-color-accent="blue"  aria-label="ライトモードに切替"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="ライトモードに切替" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="検索" placeholder="検索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="検索">
        
        <button type="reset" class="md-search__icon md-icon" title="クリア" aria-label="クリア" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            検索を初期化
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="タブ" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  ホーム

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../01_design/" class="md-tabs__link">
          
  
  
  GCP + Firebase

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../bolt-supabase/01_design/" class="md-tabs__link">
          
  
  
  Bolt + Supabase

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../code/nodejs/" class="md-tabs__link">
          
  
  
  ソースコード

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../claude-code/" class="md-tabs__link">
          
  
  
  Claude Code

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="ナビゲーション" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="AIチャットアプリ構築ガイド" class="md-nav__button md-logo" aria-label="AIチャットアプリ構築ガイド" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 21.5c-1.35-.85-3.8-1.5-5.5-1.5-1.65 0-3.35.3-4.75 1.05-.1.05-.15.05-.25.05-.25 0-.5-.25-.5-.5V6c.6-.45 1.25-.75 2-1 1.11-.35 2.33-.5 3.5-.5 1.95 0 4.05.4 5.5 1.5 1.45-1.1 3.55-1.5 5.5-1.5 1.17 0 2.39.15 3.5.5.75.25 1.4.55 2 1v14.6c0 .25-.25.5-.5.5-.1 0-.15 0-.25-.05-1.4-.75-3.1-1.05-4.75-1.05-1.7 0-4.15.65-5.5 1.5M12 8v11.5c1.35-.85 3.8-1.5 5.5-1.5 1.2 0 2.4.15 3.5.5V7c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5m1 3.5c1.11-.68 2.6-1 4.5-1 .91 0 1.76.09 2.5.28V9.23c-.87-.15-1.71-.23-2.5-.23q-2.655 0-4.5.84zm4.5.17c-1.71 0-3.21.26-4.5.79v1.69c1.11-.65 2.6-.99 4.5-.99 1.04 0 1.88.08 2.5.24v-1.5c-.87-.16-1.71-.23-2.5-.23m2.5 2.9c-.87-.16-1.71-.24-2.5-.24-1.83 0-3.33.27-4.5.8v1.69c1.11-.66 2.6-.99 4.5-.99 1.04 0 1.88.08 2.5.24z"/></svg>

    </a>
    AIチャットアプリ構築ガイド
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ホーム
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    GCP + Firebase
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    GCP + Firebase
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../01_design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    構築設計書
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    構築手順書
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    構築手順書
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目次">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目次
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        事前準備チェック
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        全体構成
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="全体構成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        仕組みの概要
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        何を作るか
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        なぜこの構成？
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-1-firebase15" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 1: Firebaseプロジェクト作成（15分）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 1: Firebaseプロジェクト作成（15分）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-1-firebase" class="md-nav__link">
    <span class="md-ellipsis">
      
        1-1. Firebaseプロジェクト作成
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-2-id" class="md-nav__link">
    <span class="md-ellipsis">
      
        1-2. プロジェクトIDの確認
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-firebase-authentication10" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 2: Firebase Authentication設定（10分）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 2: Firebase Authentication設定（10分）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2-1-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      
        2-1. Authentication有効化
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-2-google" class="md-nav__link">
    <span class="md-ellipsis">
      
        2-2. Googleログインを有効化
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-3" class="md-nav__link">
    <span class="md-ellipsis">
      
        2-3. ウェブアプリを登録
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-gcp-api5" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 3: GCP API有効化（5分）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 3: GCP API有効化（5分）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#3-1-gcp" class="md-nav__link">
    <span class="md-ellipsis">
      
        3-1. GCPコンソールにアクセス
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-2-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        3-2. API有効化
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-secret-manager10" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 4: Secret Manager設定（10分）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 4: Secret Manager設定（10分）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#4-1-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        4-1. APIキー保存
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-2" class="md-nav__link">
    <span class="md-ellipsis">
      
        4-2. サービスアカウントへの権限付与
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-5-cloud-run-functions30" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 5: Cloud Run functions作成（30分）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 5: Cloud Run functions作成（30分）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#5-1" class="md-nav__link">
    <span class="md-ellipsis">
      
        5-1. 関数の作成を開始
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-2" class="md-nav__link">
    <span class="md-ellipsis">
      
        5-2. 基本情報の設定（画面上部）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5-2. 基本情報の設定（画面上部）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        サービス名とリージョン
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        ランタイム
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        トリガー（省略可）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      
        認証（重要）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      
        課金
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      
        サービスのスケーリング（画面上部）
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-3" class="md-nav__link">
    <span class="md-ellipsis">
      
        5-3. コンテナ、ネットワーキング、セキュリティの設定
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5-3. コンテナ、ネットワーキング、セキュリティの設定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      
        「コンテナ」タブ → 「コンテナの編集」
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="「コンテナ」タブ → 「コンテナの編集」">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      
        設定タブ
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="設定タブ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      
        リソース
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      
        リクエスト
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      
        実行環境
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      
        リビジョン スケーリング
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      
        変数とシークレット タブ
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="変数とシークレット タブ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      
        環境変数
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      
        環境変数として公開されるシークレット
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      
        セキュリティ タブ
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-4" class="md-nav__link">
    <span class="md-ellipsis">
      
        5-4. ソースコードの設定
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5-4. ソースコードの設定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      
        ソースの場所
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      
        エントリポイント（重要）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      
        ソースコード
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ソースコード">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gcp_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        GCPへの貼り付け手順
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-5" class="md-nav__link">
    <span class="md-ellipsis">
      
        5-5. デプロイ
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-6-url" class="md-nav__link">
    <span class="md-ellipsis">
      
        5-6. 関数URLの確認
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-7-firebase" class="md-nav__link">
    <span class="md-ellipsis">
      
        5-7. Firebase認証済みドメインの追加（重要）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5-7. Firebase認証済みドメインの追加（重要）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      
        なぜ必要か？
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      
        設定手順
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-6-5" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 6: 動作確認（5分）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 6: 動作確認（5分）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#6-1" class="md-nav__link">
    <span class="md-ellipsis">
      
        6-1. アクセス確認
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-2" class="md-nav__link">
    <span class="md-ellipsis">
      
        6-2. ログインテスト
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-3" class="md-nav__link">
    <span class="md-ellipsis">
      
        6-3. チャットテスト
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      
        完了チェック
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      
        トラブルシューティング
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="トラブルシューティング">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cloud-run-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cloud Run functionsのデプロイが失敗する
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#status-ok" class="md-nav__link">
    <span class="md-ellipsis">
      
        「{"status": "ok"}」が表示されない
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      
        チャットでエラーが出る
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cors" class="md-nav__link">
    <span class="md-ellipsis">
      
        CORSエラーが出る
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#url" class="md-nav__link">
    <span class="md-ellipsis">
      
        重要なURL
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      
        本番運用時のセキュリティ設定
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="本番運用時のセキュリティ設定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      
        必須設定
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="必須設定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cors_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        CORS設定の変更方法
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      
        アクセス制限の設定
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      
        推奨設定（より安全に運用したい場合）
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      
        参考: 別のアーキテクチャパターン
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../03_deploy_cost/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    追加デプロイ手順
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../99_cloudrun/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    補足 - CloudRun版
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../99_custom_domain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    補足 - カスタムドメイン
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../99_container/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    補足 - コンテナイメージ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../99_service_account/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    補足 - サービスアカウント
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Bolt + Supabase
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Bolt + Supabase
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bolt-supabase/01_design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    構築設計書
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bolt-supabase/02_setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    構築手順書
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    ソースコード
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    ソースコード
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Node.js
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Node.js
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code/nodejs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code/nodejs/backend/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    backend.js
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code/nodejs/front/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    front.html
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code/nodejs/script/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    script.js
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code/nodejs/package/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    package.json
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Python
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Python
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code/python/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code/python/backend/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    backend.py
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code/python/front/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    front.html
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code/python/script/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    script.js
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code/python/requirements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    requirements.txt
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Claude Code
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Claude Code
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../claude-code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../claude-code/claude_md/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLAUDE.md
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../claude-code/settings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    settings.json
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    ルール
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    ルール
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../claude-code/00_project_context/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    00_project_context
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../claude-code/01_comment_policy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    01_comment_policy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../claude-code/02_system_architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    02_system_architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../claude-code/03_directory_structure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    03_directory_structure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../claude-code/04_boundary_policy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    04_boundary_policy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../claude-code/05_security_notes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    05_security_notes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../claude-code/06_cloudrun_ops/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    06_cloudrun_ops
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../claude-code/99_for_non_engineers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    99_for_non_engineers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目次">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目次
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        事前準備チェック
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        全体構成
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="全体構成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        仕組みの概要
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        何を作るか
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        なぜこの構成？
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-1-firebase15" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 1: Firebaseプロジェクト作成（15分）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 1: Firebaseプロジェクト作成（15分）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-1-firebase" class="md-nav__link">
    <span class="md-ellipsis">
      
        1-1. Firebaseプロジェクト作成
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-2-id" class="md-nav__link">
    <span class="md-ellipsis">
      
        1-2. プロジェクトIDの確認
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-firebase-authentication10" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 2: Firebase Authentication設定（10分）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 2: Firebase Authentication設定（10分）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2-1-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      
        2-1. Authentication有効化
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-2-google" class="md-nav__link">
    <span class="md-ellipsis">
      
        2-2. Googleログインを有効化
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-3" class="md-nav__link">
    <span class="md-ellipsis">
      
        2-3. ウェブアプリを登録
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-gcp-api5" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 3: GCP API有効化（5分）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 3: GCP API有効化（5分）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#3-1-gcp" class="md-nav__link">
    <span class="md-ellipsis">
      
        3-1. GCPコンソールにアクセス
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-2-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        3-2. API有効化
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-secret-manager10" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 4: Secret Manager設定（10分）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 4: Secret Manager設定（10分）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#4-1-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        4-1. APIキー保存
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-2" class="md-nav__link">
    <span class="md-ellipsis">
      
        4-2. サービスアカウントへの権限付与
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-5-cloud-run-functions30" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 5: Cloud Run functions作成（30分）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 5: Cloud Run functions作成（30分）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#5-1" class="md-nav__link">
    <span class="md-ellipsis">
      
        5-1. 関数の作成を開始
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-2" class="md-nav__link">
    <span class="md-ellipsis">
      
        5-2. 基本情報の設定（画面上部）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5-2. 基本情報の設定（画面上部）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        サービス名とリージョン
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        ランタイム
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        トリガー（省略可）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      
        認証（重要）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      
        課金
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      
        サービスのスケーリング（画面上部）
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-3" class="md-nav__link">
    <span class="md-ellipsis">
      
        5-3. コンテナ、ネットワーキング、セキュリティの設定
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5-3. コンテナ、ネットワーキング、セキュリティの設定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      
        「コンテナ」タブ → 「コンテナの編集」
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="「コンテナ」タブ → 「コンテナの編集」">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      
        設定タブ
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="設定タブ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      
        リソース
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      
        リクエスト
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      
        実行環境
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      
        リビジョン スケーリング
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      
        変数とシークレット タブ
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="変数とシークレット タブ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      
        環境変数
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      
        環境変数として公開されるシークレット
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      
        セキュリティ タブ
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-4" class="md-nav__link">
    <span class="md-ellipsis">
      
        5-4. ソースコードの設定
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5-4. ソースコードの設定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      
        ソースの場所
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      
        エントリポイント（重要）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      
        ソースコード
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ソースコード">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gcp_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        GCPへの貼り付け手順
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-5" class="md-nav__link">
    <span class="md-ellipsis">
      
        5-5. デプロイ
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-6-url" class="md-nav__link">
    <span class="md-ellipsis">
      
        5-6. 関数URLの確認
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-7-firebase" class="md-nav__link">
    <span class="md-ellipsis">
      
        5-7. Firebase認証済みドメインの追加（重要）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5-7. Firebase認証済みドメインの追加（重要）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      
        なぜ必要か？
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      
        設定手順
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-6-5" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 6: 動作確認（5分）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 6: 動作確認（5分）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#6-1" class="md-nav__link">
    <span class="md-ellipsis">
      
        6-1. アクセス確認
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-2" class="md-nav__link">
    <span class="md-ellipsis">
      
        6-2. ログインテスト
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-3" class="md-nav__link">
    <span class="md-ellipsis">
      
        6-3. チャットテスト
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      
        完了チェック
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      
        トラブルシューティング
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="トラブルシューティング">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cloud-run-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cloud Run functionsのデプロイが失敗する
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#status-ok" class="md-nav__link">
    <span class="md-ellipsis">
      
        「{"status": "ok"}」が表示されない
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      
        チャットでエラーが出る
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cors" class="md-nav__link">
    <span class="md-ellipsis">
      
        CORSエラーが出る
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#url" class="md-nav__link">
    <span class="md-ellipsis">
      
        重要なURL
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      
        本番運用時のセキュリティ設定
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="本番運用時のセキュリティ設定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      
        必須設定
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="必須設定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cors_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        CORS設定の変更方法
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      
        アクセス制限の設定
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      
        推奨設定（より安全に運用したい場合）
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      
        参考: 別のアーキテクチャパターン
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="gcp">GCP環境 構築手順書<a class="headerlink" href="#gcp" title="Permanent link">&para;</a></h1>
<table>
<thead>
<tr>
<th>項目</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>対象者</td>
<td>非エンジニア</td>
</tr>
<tr>
<td>作業時間</td>
<td>約1〜2時間</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="_1">事前準備チェック<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th style="text-align: center;">チェック</th>
<th>項目</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">☐</td>
<td>Googleアカウント（管理者権限）</td>
</tr>
<tr>
<td style="text-align: center;">☐</td>
<td>クレジットカード（GCP課金用）</td>
</tr>
<tr>
<td style="text-align: center;">☐</td>
<td>AIのAPIキー（OpenAI等）</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="_2">全体構成<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="_3">仕組みの概要<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>あなた（ブラウザ）
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    |
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    | (1) アクセス
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    v
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>Cloud Run functions
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    |
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    | (2) ログインしてる？
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    v
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>Firebase Auth（認証） ←── Googleアカウントでログイン
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    |
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    | (3) ログイン済みならOK
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    v
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>Cloud Run functions
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    |
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    | (4) APIキーを取得
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    v
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>Secret Manager（鍵の金庫）
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    |
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    | (5) AI に質問
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    v
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>OpenAI API（ChatGPT）
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    |
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    | (6) 回答
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    v
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>あなた（ブラウザ）に表示
</code></pre></div>
<h3 id="_4">何を作るか<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>作るもの</th>
<th>役割</th>
<th style="text-align: center;">個数</th>
</tr>
</thead>
<tbody>
<tr>
<td>Firebase プロジェクト</td>
<td>Googleログイン認証</td>
<td style="text-align: center;">1つ</td>
</tr>
<tr>
<td>Cloud Run functions</td>
<td>チャット画面の表示 + AI呼び出し</td>
<td style="text-align: center;">1つ</td>
</tr>
<tr>
<td>Secret Manager のシークレット</td>
<td>APIキーの保管</td>
<td style="text-align: center;">1つ</td>
</tr>
</tbody>
</table>
<h3 id="_5">なぜこの構成？<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>特徴</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>認証あり</td>
<td>Googleアカウントでログインした人だけ使える</td>
</tr>
<tr>
<td>シンプル</td>
<td>作成するのは<strong>3つだけ</strong></td>
</tr>
<tr>
<td>安全</td>
<td>APIキーは暗号化して保管（コードに書かない）</td>
</tr>
<tr>
<td>無料枠あり</td>
<td>少量アクセスなら無料枠内で運用可能</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>コストについて</strong></p>
<table>
<thead>
<tr>
<th>サービス</th>
<th>無料枠</th>
<th>超過時の課金</th>
</tr>
</thead>
<tbody>
<tr>
<td>Firebase Auth</td>
<td>月5万認証まで無料</td>
<td>ほぼ無料で収まる</td>
</tr>
<tr>
<td>Cloud Run functions</td>
<td>月200万リクエストまで無料</td>
<td>リクエスト数に応じて課金</td>
</tr>
<tr>
<td>Secret Manager</td>
<td>月6シークレット・6,000アクセスまで無料</td>
<td>微量課金</td>
</tr>
<tr>
<td><strong>OpenAI API</strong></td>
<td><strong>無料枠なし</strong></td>
<td><strong>利用量に応じて課金</strong></td>
</tr>
</tbody>
</table>
<p><strong>注意</strong>: Firebase/GCPは無料枠がありますが、<strong>OpenAI等の外部AI APIは従量課金</strong>です。
テスト段階では数円〜数十円程度ですが、本番運用時はAPI利用料金が発生します。</p>
</blockquote>
<hr />
<h2 id="step-1-firebase15">Step 1: Firebaseプロジェクト作成（15分）<a class="headerlink" href="#step-1-firebase15" title="Permanent link">&para;</a></h2>
<blockquote>
<p><strong>FirebaseとGCPの関係</strong></p>
<p>Firebaseでプロジェクトを作成すると、<strong>GCPプロジェクトも自動的に作成</strong>されます。
別々に作成する必要はありません。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>Firebaseでプロジェクト作成
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>    ↓
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>自動的にGCPプロジェクトも作成される
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    ↓
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>両方のコンソールで同じプロジェクトを操作できる
</code></pre></div>
<table>
<thead>
<tr>
<th>コンソール</th>
<th>URL</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>Firebase</td>
<td>console.firebase.google.com</td>
<td>認証（Auth）、ウェブアプリ設定</td>
</tr>
<tr>
<td>GCP</td>
<td>console.cloud.google.com</td>
<td>Cloud Run functions、Secret Manager</td>
</tr>
</tbody>
</table>
</blockquote>
<h3 id="1-1-firebase">1-1. Firebaseプロジェクト作成<a class="headerlink" href="#1-1-firebase" title="Permanent link">&para;</a></h3>
<ol>
<li>https://console.firebase.google.com にアクセス</li>
<li>Googleアカウントでログイン</li>
<li>「<strong>プロジェクトを作成</strong>」をクリック</li>
</ol>
<blockquote>
<p><strong>「プロジェクトを追加」と表示される場合</strong>
既にFirebaseプロジェクトがある場合は「プロジェクトを追加」と表示されます。
どちらも同じ操作です。</p>
</blockquote>
<ol>
<li>プロジェクト名を入力（例: <code>ai-chat-app</code>）</li>
<li>この名前がGCPプロジェクト名にもなります</li>
<li>
<p>プロジェクトIDは自動生成されます（例: <code>ai-chat-app-89fe2</code>）</p>
</li>
<li>
<p>「続行」をクリック</p>
</li>
<li>
<p>Googleアナリティクス: 今回は「<strong>このプロジェクトでGoogleアナリティクスを有効にする</strong>」を<strong>オフ</strong>にする</p>
</li>
<li>テスト環境では不要です</li>
<li>
<p>後から有効化することも可能です</p>
</li>
<li>
<p>「<strong>プロジェクトを作成</strong>」をクリック</p>
</li>
<li>
<p>「新しいプロジェクトの準備ができました」と表示されたら「<strong>続行</strong>」をクリック</p>
</li>
</ol>
<h3 id="1-2-id">1-2. プロジェクトIDの確認<a class="headerlink" href="#1-2-id" title="Permanent link">&para;</a></h3>
<p>作成後、プロジェクトIDを確認しておきます（後で使用します）。</p>
<ol>
<li>左上の<strong>歯車アイコン（⚙️）</strong>をクリック</li>
<li>「<strong>プロジェクトの設定</strong>」をクリック</li>
<li>以下の情報をメモしておく:</li>
</ol>
<table>
<thead>
<tr>
<th>項目</th>
<th>例</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>プロジェクト名</td>
<td><code>ai-chat-app</code></td>
<td>表示名</td>
</tr>
<tr>
<td>プロジェクトID</td>
<td><code>ai-chat-app-89fe2</code></td>
<td>GCPでの識別に使用</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>GCPコンソールでの確認方法</strong></p>
<p>https://console.cloud.google.com にアクセスすると、
画面上部のプロジェクト選択で先ほど作成したプロジェクト（例: <code>ai-chat-app-89fe2</code>）が
表示されていることを確認できます。</p>
</blockquote>
<hr />
<h2 id="step-2-firebase-authentication10">Step 2: Firebase Authentication設定（10分）<a class="headerlink" href="#step-2-firebase-authentication10" title="Permanent link">&para;</a></h2>
<blockquote>
<p><strong>Firebase Authとは？</strong>
Googleが提供する認証サービスです。
「Googleアカウントでログイン」ボタンを簡単に実装できます。</p>
<table>
<thead>
<tr>
<th>メリット</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>簡単</td>
<td>数行のコードでログイン機能が完成</td>
</tr>
<tr>
<td>安全</td>
<td>パスワード管理はGoogleにお任せ</td>
</tr>
<tr>
<td>無料</td>
<td>月5万人まで無料</td>
</tr>
</tbody>
</table>
</blockquote>
<h3 id="2-1-authentication">2-1. Authentication有効化<a class="headerlink" href="#2-1-authentication" title="Permanent link">&para;</a></h3>
<ol>
<li>Firebaseコンソールの左メニューから「<strong>構築</strong>」を展開</li>
<li>「<strong>Authentication</strong>」をクリック</li>
<li>「<strong>始める</strong>」をクリック</li>
</ol>
<blockquote>
<p><strong>画面が異なる場合</strong>
既にAuthenticationが有効な場合は「始める」ボタンは表示されません。
その場合は次の手順に進んでください。</p>
</blockquote>
<h3 id="2-2-google">2-2. Googleログインを有効化<a class="headerlink" href="#2-2-google" title="Permanent link">&para;</a></h3>
<ol>
<li>「<strong>ログイン方法</strong>」タブをクリック</li>
<li>「<strong>新しいプロバイダを追加</strong>」をクリック</li>
<li>
<p>「<strong>Google</strong>」を選択</p>
</li>
<li>
<p>以下を設定:
   | 項目 | 設定 |
   |------|------|
   | 有効にする | <strong>オン</strong>（トグルをクリック） |
   | プロジェクトのサポートメール | 自分のメールアドレスを選択 |</p>
</li>
<li>
<p>「<strong>保存</strong>」をクリック</p>
</li>
</ol>
<blockquote>
<p><strong>設定完了後の画面</strong></p>
<table>
<thead>
<tr>
<th>プロバイダ</th>
<th>ステータス</th>
</tr>
</thead>
<tbody>
<tr>
<td>Google</td>
<td>有効</td>
</tr>
</tbody>
</table>
<p>と表示されていればOKです。</p>
</blockquote>
<h3 id="2-3">2-3. ウェブアプリを登録<a class="headerlink" href="#2-3" title="Permanent link">&para;</a></h3>
<p>Firebase設定情報を取得するため、ウェブアプリを登録します。</p>
<ol>
<li>左上の<strong>家アイコン</strong>（プロジェクトの概要）をクリックしてトップページに戻る</li>
<li>「<strong>＋ アプリを追加</strong>」ボタンをクリック</li>
</ol>
<blockquote>
<p><strong>「＋ アプリを追加」が見つからない場合</strong>
プロジェクトの概要ページで、プロジェクト名の下に
「アプリを追加してください」というメッセージがあります。
そこから追加することもできます。</p>
</blockquote>
<ol>
<li>
<p>プラットフォームの選択画面で「<strong>ウェブ</strong>」（ウェブアイコン）をクリック</p>
</li>
<li>
<p>アプリ情報を入力:
   | 項目 | 入力値 |
   |------|--------|
   | アプリのニックネーム | <code>ai-chat-web</code>（任意の名前） |
   | Firebase Hosting | チェック<strong>しない</strong>（今回は不要） |</p>
</li>
</ol>
<blockquote>
<p><strong>Firebase Hosting とは？</strong>
Firebaseが提供する<strong>静的ウェブサイトのホスティングサービス</strong>です。
HTML/CSS/JavaScriptファイルを置くだけでウェブサイトを公開できます。
今回はCloud Run functionsでフロントエンドも配信するため、Firebase Hostingは使用しません。</p>
</blockquote>
<ol>
<li>
<p>「<strong>アプリを登録</strong>」をクリック</p>
</li>
<li>
<p>「<strong>Firebase SDK の追加</strong>」画面が表示されます</p>
</li>
<li>表示される <code>firebaseConfig</code> の内容を<strong>メモまたはコピー</strong>しておく</li>
</ol>
<blockquote>
<p><strong>SDK（エスディーケー）とは？</strong>
<strong>Software Development Kit</strong>の略で、「開発用の道具セット」という意味です。
Firebaseの機能（ログイン機能など）をアプリから簡単に使うための部品集です。
ここで表示される <code>firebaseConfig</code> は、あなたのプロジェクト専用の接続情報です。</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1">// この情報は後でコードに貼り付けます（値は各プロジェクトで異なります）</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kd">const</span><span class="w"> </span><span class="nx">firebaseConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">  </span><span class="nx">apiKey</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span><span class="p">,</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">  </span><span class="nx">authDomain</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;ai-chat-app-89fe2.firebaseapp.com&quot;</span><span class="p">,</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">  </span><span class="nx">projectId</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;ai-chat-app-89fe2&quot;</span><span class="p">,</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">  </span><span class="nx">storageBucket</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;ai-chat-app-89fe2.appspot.com&quot;</span><span class="p">,</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">  </span><span class="nx">messagingSenderId</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;123456789012&quot;</span><span class="p">,</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">  </span><span class="nx">appId</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;1:123456789012:web:xxxxxxxxxxxxxxxxxx&quot;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="p">};</span>
</code></pre></div>
<ol>
<li>「<strong>コンソールに進む</strong>」をクリック</li>
</ol>
<blockquote>
<p><strong>後からfirebaseConfigを確認する方法</strong></p>
<ol>
<li>歯車アイコン（⚙️）→「プロジェクトの設定」</li>
<li>「全般」タブの下部「マイアプリ」セクション</li>
<li>登録したウェブアプリをクリック</li>
<li>「SDK の設定と構成」で確認できます</li>
</ol>
</blockquote>
<hr />
<h2 id="step-3-gcp-api5">Step 3: GCP API有効化（5分）<a class="headerlink" href="#step-3-gcp-api5" title="Permanent link">&para;</a></h2>
<p>Cloud Run functionsとSecret Managerを使用するために、GCPで必要なAPIを有効化します。</p>
<h3 id="3-1-gcp">3-1. GCPコンソールにアクセス<a class="headerlink" href="#3-1-gcp" title="Permanent link">&para;</a></h3>
<ol>
<li>https://console.cloud.google.com にアクセス</li>
<li>画面上部のプロジェクト選択で、<strong>Firebaseで作成したプロジェクト</strong>を選択</li>
<li>例: <code>ai-chat-app-89fe2</code></li>
</ol>
<blockquote>
<p><strong>プロジェクトが見つからない場合</strong>
プロジェクト選択画面で「すべて」タブを確認してください。
Firebaseで作成したプロジェクトは自動的にGCPにも表示されます。</p>
</blockquote>
<h3 id="3-2-api">3-2. API有効化<a class="headerlink" href="#3-2-api" title="Permanent link">&para;</a></h3>
<ol>
<li>左メニュー「<strong>APIとサービス</strong>」→「<strong>ライブラリ</strong>」をクリック</li>
<li>以下のAPIを<strong>それぞれ検索して有効化</strong>:</li>
</ol>
<table>
<thead>
<tr>
<th>API名</th>
<th>検索ワード</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cloud Run Admin API</td>
<td><code>Cloud Run</code></td>
<td>Cloud Run functionsの作成・管理</td>
</tr>
<tr>
<td>Cloud Build API</td>
<td><code>Cloud Build</code></td>
<td>コードのビルド</td>
</tr>
<tr>
<td>Secret Manager API</td>
<td><code>Secret Manager</code></td>
<td>APIキーの安全な保管</td>
</tr>
</tbody>
</table>
<p><strong>各APIの有効化手順:</strong>
1. 検索バーにAPI名を入力
2. 検索結果からAPIをクリック
3. 「<strong>有効にする</strong>」ボタンをクリック
4. 有効化が完了するまで待つ（数秒〜1分程度）</p>
<blockquote>
<p><strong>既に有効な場合</strong>
「有効にする」ではなく「管理」と表示されている場合は、既に有効です。
何もせず次のAPIに進んでください。</p>
</blockquote>
<hr />
<h2 id="step-4-secret-manager10">Step 4: Secret Manager設定（10分）<a class="headerlink" href="#step-4-secret-manager10" title="Permanent link">&para;</a></h2>
<h3 id="4-1-api">4-1. APIキー保存<a class="headerlink" href="#4-1-api" title="Permanent link">&para;</a></h3>
<blockquote>
<p><strong>Secret Managerとは？</strong>
AIサービス（OpenAI等）のAPIキーを<strong>安全に暗号化して保管</strong>するためのサービスです。</p>
<table>
<thead>
<tr>
<th>保存方法</th>
<th>問題点</th>
</tr>
</thead>
<tbody>
<tr>
<td>コードに直接書く</td>
<td>GitHubに漏洩 → 不正利用で高額請求</td>
</tr>
<tr>
<td>環境変数に直接設定</td>
<td>GCPコンソール画面に<strong>平文で丸見え</strong></td>
</tr>
<tr>
<td><strong>Secret Manager</strong></td>
<td>暗号化保存 + アクセス権限管理</td>
</tr>
</tbody>
</table>
</blockquote>
<ol>
<li>GCPコンソール →「Secret Manager」→「シークレットを作成」</li>
<li>名前: <code>openai-api-key</code></li>
<li>シークレットの値: OpenAIのAPIキーを入力</li>
<li>「シークレットを作成」</li>
</ol>
<blockquote>
<p><strong>【命名規則の推奨】マルチテナント運用時</strong></p>
<p>複数のクライアント（テナント）を管理する場合、シークレット名に<strong>テナントIDをプレフィックス</strong>として付けることを強く推奨します。</p>
<table>
<thead>
<tr>
<th>構成</th>
<th>命名規則</th>
<th>例</th>
</tr>
</thead>
<tbody>
<tr>
<td>シングルテナント（1社のみ）</td>
<td><code>{用途}</code></td>
<td><code>openai-api-key</code></td>
</tr>
<tr>
<td>マルチテナント（複数社）</td>
<td><code>{テナントID}-{用途}</code></td>
<td><code>companya-openai-key</code></td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>【マルチテナントの場合のSecret Manager一覧】
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>companya-openai-key      ← A社用のOpenAI APIキー
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>companya-anthropic-key   ← A社用のAnthropic APIキー
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>companyb-openai-key      ← B社用のOpenAI APIキー
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>companyc-dify-key        ← C社用のDify APIキー
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>→ プレフィックスでどのテナントか一目瞭然！
</code></pre></div>
<p><strong>なぜ命名規則が重要か？</strong>
- シークレットが増えると「どれがどのクライアント用か」が分からなくなる
- 誤って別テナントのAPIキーを紐付けるリスクを防止
- 管理画面での検索・フィルタリングが容易になる</p>
<p><strong>【テスト環境の場合】</strong>
実際のAPIキーがない場合は、以下のダミー値で手順を練習できます：
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>sk-test-dummy-key-12345
</code></pre></div>
※ ダミー値ではAI機能は動作しませんが、環境構築の手順確認には使用できます。</p>
</blockquote>
<h3 id="4-2">4-2. サービスアカウントへの権限付与<a class="headerlink" href="#4-2" title="Permanent link">&para;</a></h3>
<p>シークレットを作成したら、Cloud Runがシークレットにアクセスできるように権限を付与します。</p>
<blockquote>
<p><strong>⚠️ この手順を忘れると？</strong></p>
<p>Cloud Runデプロイ時に以下のエラーが発生します：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>Permission denied on secret: projects/xxx/secrets/openai-api-key/versions/latest
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>for Revision service account xxx@xxx.iam.gserviceaccount.com.
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>The service account used must be granted the &#39;Secret Manager Secret Accessor&#39; role
</code></pre></div>
</blockquote>
<p><strong>権限付与の手順</strong></p>
<ol>
<li>GCPコンソールで「<strong>IAMと管理</strong>」→「<strong>IAM</strong>」を開く</li>
<li>使用するサービスアカウントを探す</li>
<li>推奨: <code>firebase-adminsdk-xxxxx@[プロジェクトID].iam.gserviceaccount.com</code></li>
<li>※ <code>xxxxx</code> と <code>[プロジェクトID]</code> は各プロジェクトで異なります</li>
<li>右の<strong>鉛筆アイコン（編集）</strong>をクリック</li>
<li>「<strong>別のロールを追加</strong>」をクリック</li>
<li>「<code>Secret Manager Secret Accessor</code>」または「<code>Secret Manager のシークレット アクセサー</code>」を検索して選択</li>
<li>「<strong>保存</strong>」をクリック</li>
</ol>
<blockquote>
<p><strong>どのサービスアカウントに権限を付与するか？</strong></p>
<table>
<thead>
<tr>
<th>サービスアカウント</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>firebase-adminsdk-xxxxx@...</code>（推奨）</td>
<td>Firebase関連の権限も持っている。Step 5でCloud Runに設定する</td>
</tr>
<tr>
<td><code>xxxxx-compute@developer.gserviceaccount.com</code></td>
<td>デフォルトのCompute Engine サービスアカウント</td>
</tr>
</tbody>
</table>
<p><strong>推奨</strong>: <code>firebase-adminsdk</code> を使用し、Step 5のセキュリティタブでこのサービスアカウントを選択します。</p>
</blockquote>
<hr />
<h2 id="step-5-cloud-run-functions30">Step 5: Cloud Run functions作成（30分）<a class="headerlink" href="#step-5-cloud-run-functions30" title="Permanent link">&para;</a></h2>
<blockquote>
<p><strong>Cloud Run functions とは？</strong>
コードを書くだけでサーバーなしで動くWebアプリを作れるサービスです。</p>
<table>
<thead>
<tr>
<th>従来の方法</th>
<th>Cloud Run functions</th>
</tr>
</thead>
<tbody>
<tr>
<td>サーバーを借りる → OS設定 → Node.js入れる → アプリ設置</td>
<td>コードを貼り付け → 動く！</td>
</tr>
</tbody>
</table>
<p><strong>名称について</strong>
以前は「Cloud Functions」という名前でしたが、現在は「Cloud Run functions」に名称変更されました。
GCPコンソールでは「Cloud Run」→「関数を作成」から利用します。</p>
<p><strong>補足: コンテナイメージについて</strong>
Cloud Run functions版では、コードを貼り付けるだけでGCPが自動的に実行環境を用意してくれます。
そのため、Dockerやコンテナイメージの知識は不要です。
「コンテナイメージとは何か？」を知りたい方は <a href="../99_container/">99_container.md</a> を参照してください。</p>
</blockquote>
<h3 id="5-1">5-1. 関数の作成を開始<a class="headerlink" href="#5-1" title="Permanent link">&para;</a></h3>
<ol>
<li>GCPコンソール（https://console.cloud.google.com）を開く</li>
<li>左側メニューから「Cloud Run」をクリック</li>
<li>上部の「＋ 関数を作成」ボタンをクリック</li>
</ol>
<blockquote>
<p><strong>「関数を作成」が見つからない場合</strong>
「＋ サービスを作成」ではなく「＋ 関数を作成」を選んでください。
見つからない場合は、検索バーで「Cloud Run functions」と検索してください。</p>
</blockquote>
<h3 id="5-2">5-2. 基本情報の設定（画面上部）<a class="headerlink" href="#5-2" title="Permanent link">&para;</a></h3>
<p>画面の上から順に設定していきます。</p>
<h4 id="_6">サービス名とリージョン<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>項目</th>
<th>設定値</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>サービス名</td>
<td><code>ai-chat-app</code></td>
<td>この関数を識別する名前（半角英数字とハイフンのみ）</td>
</tr>
<tr>
<td>リージョン</td>
<td><code>asia-northeast1（東京）</code></td>
<td>サーバーの場所。日本のユーザー向けなら東京を選択</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>リージョンとは？</strong>
サーバーが物理的に設置されている場所です。
ユーザーに近いリージョンを選ぶと、応答速度が速くなります。</p>
<table>
<thead>
<tr>
<th>リージョン</th>
<th>場所</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>asia-northeast1</td>
<td>東京</td>
<td>日本国内向け（推奨）</td>
</tr>
<tr>
<td>asia-northeast2</td>
<td>大阪</td>
<td>東京のバックアップ</td>
</tr>
<tr>
<td>us-central1</td>
<td>アイオワ</td>
<td>海外向け・コスト重視</td>
</tr>
</tbody>
</table>
</blockquote>
<h4 id="_7">ランタイム<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>項目</th>
<th>設定値</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>ランタイム</td>
<td><code>Node.js 24</code> または <code>Node.js 20</code></td>
<td>プログラムの実行環境（言語とバージョン）</td>
</tr>
</tbody>
</table>
<h4 id="_8">トリガー（省略可）<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h4>
<p>「＋ トリガーを追加」をクリックして、HTTPSトリガーを設定します。
（省略した場合もHTTPSトリガーが自動で設定されます）</p>
<h4 id="_9">認証（重要）<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>項目</th>
<th>設定値</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>認証</td>
<td><strong>公開アクセスを許可する</strong></td>
<td>誰でもURLにアクセス可能</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>「公開アクセスを許可する」を選択する理由</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>2段階の認証になっています：
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>┌─────────────────────────────────────────────────┐
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>│ 1段階目: Cloud Run の認証（GCPレベル）            │
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>│                                                 │
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>│   「公開アクセスを許可する」                       │
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>│   = 誰でもURLにアクセスできる                     │
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>│   = ログイン画面を表示するため、ここは許可が必要    │
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>│                                                 │
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>│   ※「認証が必要」を選ぶと、GCPアカウントがないと   │
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>│     ログイン画面すら見れなくなってしまう           │
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>└─────────────────────────────────────────────────┘
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>                      ↓
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>┌─────────────────────────────────────────────────┐
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>│ 2段階目: アプリ側の認証（Firebase Auth）          │
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>│                                                 │
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>│   ログイン画面で「Googleでログイン」ボタンを押す   │
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>│   → ログインした人だけがチャット機能を使える      │
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>│                                                 │
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>│   ※ここで本当のアクセス制限をかけている           │
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>└─────────────────────────────────────────────────┘
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>つまり：
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>・ログイン画面は誰でも見れる（1段階目は許可）
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>・チャット機能はログインした人だけ使える（2段階目で制限）
</code></pre></div>
</blockquote>
<h4 id="_10">課金<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>項目</th>
<th>設定値</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>課金</td>
<td><strong>リクエスト ベース</strong></td>
<td>リクエストがあった時だけ課金される（推奨）</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>課金方式の違い</strong>
| 方式 | 説明 | 適したケース |
|------|------|-------------|
| リクエスト ベース | リクエストがない時はCPUが制限される。使った分だけ課金 | テスト環境、アクセス少なめ（推奨） |
| インスタンス ベース | インスタンスが起動している間ずっと課金 | 常時高負荷、応答速度重視 |</p>
</blockquote>
<h4 id="_11">サービスのスケーリング（画面上部）<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>項目</th>
<th>設定値</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>スケーリング</td>
<td><strong>自動スケーリング</strong></td>
<td>アクセス量に応じて自動で増減（推奨）</td>
</tr>
<tr>
<td>インスタンスの最小数</td>
<td><code>0</code></td>
<td>アクセスがない時に起動しておくインスタンスの数</td>
</tr>
<tr>
<td>インスタンスの最大数</td>
<td><code>10</code>（または空欄）</td>
<td>同時に起動できるインスタンスの上限</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>インスタンスとは？</strong></p>
<p>「インスタンス」とは、アプリが動いている<strong>仮想的なサーバー1台</strong>のようなものです。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>┌─────────────────────────────────────────────────┐
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>│                  分かりやすい例え                  │
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>│                                                 │
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>│     インスタンス = ファストフード店のレジ係         │
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>│                                                 │
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>│     ・お客さん数人 → レジ係1人で対応できる         │
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>│     ・お客さん100人が殺到                        │
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>│       → レジ係を10人に増やして対応（自動！）      │
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>│     ・お客さん0人（深夜など）                     │
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>│       → レジ係を帰宅させてコスト削減             │
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>└─────────────────────────────────────────────────┘
</code></pre></div>
<p><strong>⚠️ 注意: インスタンス1台 ≠ ユーザー1人 ではありません！</strong></p>
<p>1つのインスタンスは<strong>複数のリクエストを同時に処理</strong>できます。
何人まで同時に処理できるかは、次の「リクエスト」セクションで設定します。
（デフォルトは80リクエスト/インスタンス）</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>【計算例】
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>インスタンス最大数: 10
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>1インスタンスあたり: 80リクエスト
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>    ↓
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>最大 10 × 80 = 800リクエストを同時に処理可能
</code></pre></div>
<p><strong>「1に設定するとコールド スタートが減少します」とは？</strong></p>
<table>
<thead>
<tr>
<th>設定</th>
<th>動作</th>
<th>メリット</th>
<th>デメリット</th>
</tr>
</thead>
<tbody>
<tr>
<td>最小=0</td>
<td>アクセスがないとインスタンス停止</td>
<td><strong>コスト0円</strong>（使った時だけ課金）</td>
<td>初回アクセスが遅い（2〜5秒待つ）</td>
</tr>
<tr>
<td>最小=1</td>
<td>常に1台は起動しておく</td>
<td>常に高速応答</td>
<td><strong>常時課金が発生</strong>（月$5〜10程度）</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>【最小=0 の場合（コールドスタート）】
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>ユーザーがアクセス
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    ↓
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>インスタンスが停止中...（誰もいない店）
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>    ↓
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>起動開始（店を開けて準備中）
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>    ↓
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>2〜5秒後に応答 ← この待ち時間が「コールドスタート」
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>【最小=1 の場合（ウォームスタート）】
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>ユーザーがアクセス
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>    ↓
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>インスタンスは起動済み！（店はすでに営業中）
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>    ↓
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>すぐに応答
</code></pre></div>
<p><strong>テスト環境では最小=0、本番で応答速度が重要なら最小=1以上を検討してください。</strong></p>
</blockquote>
<h3 id="5-3">5-3. コンテナ、ネットワーキング、セキュリティの設定<a class="headerlink" href="#5-3" title="Permanent link">&para;</a></h3>
<p>画面下部にある「コンテナ、ネットワーキング、セキュリティ」をクリックして展開します。</p>
<h4 id="_12">「コンテナ」タブ → 「コンテナの編集」<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h4>
<h5 id="_13">設定タブ<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h5>
<h6 id="_14">リソース<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h6>
<table>
<thead>
<tr>
<th>項目</th>
<th>設定値</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>メモリ</td>
<td><code>512 MiB</code></td>
<td>アプリが使えるメモリ量。AI処理には512MB以上推奨</td>
</tr>
<tr>
<td>CPU</td>
<td><code>1</code></td>
<td>処理能力。通常は1で十分</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>メモリとCPUの関係</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>メモリ = 机の広さ（作業スペース）
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>CPU = 作業する人の数と速さ
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>AI処理では多くのデータを一時的に保持するため、
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>机（メモリ）が広い方が効率よく処理できます。
</code></pre></div></p>
</blockquote>
<h6 id="_15">リクエスト<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h6>
<table>
<thead>
<tr>
<th>項目</th>
<th>設定値</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>リクエストのタイムアウト</td>
<td><code>300</code> 秒</td>
<td>1リクエストの最大処理時間</td>
</tr>
<tr>
<td>インスタンスあたりの最大同時リクエスト数</td>
<td><code>80</code>（デフォルト）</td>
<td>1つのインスタンスが同時に処理できるリクエスト数</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>タイムアウトとは？</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>ユーザーがAIに質問
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>    ↓
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>AIが考え中...（最大300秒まで待つ）
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    ↓
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>300秒を超えると強制終了（エラー）
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>AIの応答は数秒〜30秒程度かかることがあるため、
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>余裕を持って300秒（5分）に設定しています。
</code></pre></div></p>
</blockquote>
<h6 id="_16">実行環境<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h6>
<table>
<thead>
<tr>
<th>項目</th>
<th>設定値</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>実行環境</td>
<td><strong>デフォルト</strong></td>
<td>Cloud Runが最適な環境を自動選択</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>実行環境の選択肢</strong>
| 選択肢 | 説明 |
|--------|------|
| デフォルト | Cloud Runが自動で最適な環境を選ぶ（推奨） |
| 第1世代 | コールドスタートが速い（シンプルな処理向け） |
| 第2世代 | 高性能、ネットワークファイルシステム対応（複雑な処理向け） |</p>
</blockquote>
<h6 id="_17">リビジョン スケーリング<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h6>
<p>「リビジョン スケーリング」セクションで以下を設定：</p>
<table>
<thead>
<tr>
<th>項目</th>
<th>設定値</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>インスタンスの最小数</strong></td>
<td><code>0</code></td>
<td>このリビジョンで起動しておくインスタンスの最小数</td>
</tr>
<tr>
<td><strong>インスタンスの最大数</strong></td>
<td><code>10</code></td>
<td>このリビジョンで起動できるインスタンスの上限</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>「サービスのスケーリング」と「リビジョン スケーリング」の違い</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>┌─────────────────────────────────────────────────┐
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>│ サービスのスケーリング（画面上部）                 │
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>│                                                 │
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>│   サービス全体のインスタンス数を設定              │
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>│   → 通常はこちらで設定すればOK                   │
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>└─────────────────────────────────────────────────┘
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>                      ↓
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>┌─────────────────────────────────────────────────┐
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>│ リビジョン スケーリング（コンテナ設定内）          │
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>│                                                 │
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>│   特定のリビジョン（バージョン）のインスタンス数   │
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>│   → 複数バージョンを同時運用する場合に使用        │
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>│   → 通常は上部の設定と同じ値でOK                 │
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>└─────────────────────────────────────────────────┘
</code></pre></div>
<p><strong>リビジョンとは？</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>リビジョン = アプリのバージョン
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>コードを変更してデプロイするたびに、新しいリビジョンが作成されます。
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>リビジョン1（古い） ← 問題があれば戻せる
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>    ↓
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>リビジョン2（新しい） ← 現在稼働中
</code></pre></div></p>
<p>※ インスタンスについては「サービスのスケーリング」（4-2）で説明しています。</p>
</blockquote>
<h5 id="_18">変数とシークレット タブ<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h5>
<p>「変数とシークレット」タブをクリックします。</p>
<h6 id="_19">環境変数<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h6>
<p>「＋ 変数を追加」をクリックして、以下の環境変数を追加します。</p>
<table>
<thead>
<tr>
<th>名前</th>
<th>値の例</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ALLOWED_EMAILS</code></td>
<td><code>user1@example.com,user2@example.com</code></td>
<td>ログインを許可するメールアドレス（カンマ区切り）</td>
</tr>
<tr>
<td><code>ALLOWED_DOMAINS</code></td>
<td><code>@yourcompany.co.jp</code></td>
<td>ログインを許可するドメイン（カンマ区切り）</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>環境変数とは？</strong></p>
<p>アプリに渡す「設定値」のことです。コードの中身を変えずに、動作を変更できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>【環境変数のイメージ】
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>コード（変えない）        環境変数（変える）
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>      ↓                       ↓
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>「許可リストをチェック」  →  許可リスト = &quot;user1@example.com&quot;
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>※ 許可するユーザーを追加したい時、コードは変えずに
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>   環境変数だけ変更すればOK
</code></pre></div>
</blockquote>
<hr />
<blockquote>
<p><strong>ALLOWED_EMAILS と ALLOWED_DOMAINS の詳細説明</strong></p>
<p>この2つの環境変数で「誰がこのアプリを使えるか」を制限できます。</p>
<p><strong>① ALLOWED_EMAILS（個別メールアドレス指定）</strong></p>
<table>
<thead>
<tr>
<th>設定値の例</th>
<th>許可されるユーザー</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>admin@example.com</code></td>
<td>admin@example.com のみ</td>
</tr>
<tr>
<td><code>admin@example.com,user1@gmail.com</code></td>
<td>2人のみ（カンマ区切りで複数指定可能）</td>
</tr>
</tbody>
</table>
<p><strong>② ALLOWED_DOMAINS（ドメイン指定）</strong></p>
<table>
<thead>
<tr>
<th>設定値の例</th>
<th>許可されるユーザー</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>@yourcompany.co.jp</code></td>
<td><code>xxx@yourcompany.co.jp</code> のメールを持つ全員</td>
</tr>
<tr>
<td><code>@yourcompany.co.jp,@partner.co.jp</code></td>
<td>2つの会社の全員（カンマ区切りで複数指定可能）</td>
</tr>
</tbody>
</table>
<p><strong>③ 両方設定した場合</strong></p>
<p>「どちらかに該当すれば許可」されます（OR条件）。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>例：
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>ALLOWED_EMAILS = &quot;external-user@gmail.com&quot;
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>ALLOWED_DOMAINS = &quot;@yourcompany.co.jp&quot;
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>許可されるユーザー：
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>✓ tanaka@yourcompany.co.jp   ← ドメインが一致
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>✓ suzuki@yourcompany.co.jp   ← ドメインが一致
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>✓ external-user@gmail.com    ← メールアドレスが一致
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>✗ other@gmail.com            ← どちらにも該当しない
</code></pre></div>
<p><strong>④ 片方だけ設定する場合</strong></p>
<table>
<thead>
<tr>
<th>やりたいこと</th>
<th>設定方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>会社のドメインだけで縛りたい</td>
<td><code>ALLOWED_DOMAINS</code> だけ設定する（<code>ALLOWED_EMAILS</code> は空欄または未設定）</td>
</tr>
<tr>
<td>特定の人だけ許可したい</td>
<td><code>ALLOWED_EMAILS</code> だけ設定する（<code>ALLOWED_DOMAINS</code> は空欄または未設定）</td>
</tr>
<tr>
<td>両方組み合わせたい</td>
<td>両方設定する</td>
</tr>
</tbody>
</table>
<p><strong>⑤ 両方とも未設定の場合</strong></p>
<p><strong>全員がログイン可能になります</strong>（開発・テスト用）。
本番環境では必ずどちらかを設定してください。</p>
</blockquote>
<hr />
<blockquote>
<p><strong>なぜ環境変数でアクセス制限ができるのか？（仕組みの解説）</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>【処理の流れ】
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>1. ユーザーがGoogleでログインする
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>       ↓
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>2. Googleから「この人は tanaka@yourcompany.co.jp です」という情報が返ってくる
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>       ↓
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>3. フロントエンド（front.html）がバックエンド（backend.js）に確認リクエストを送る
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>   「このメールアドレスの人は使っていいですか？」
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>       ↓
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>4. バックエンド（backend.js）が環境変数をチェック
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>   ・ALLOWED_EMAILS に含まれているか？ → NO
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>   ・ALLOWED_DOMAINS で終わっているか？ → YES（@yourcompany.co.jp で終わる）
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>       ↓
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>5. 結果を返す
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>   ・許可 → チャット画面を表示
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>   ・拒否 → 「アクセスが許可されていません」画面を表示
</code></pre></div>
<p><strong>コード内の該当部分（backend.js）</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1">// メールアドレスが許可されているかチェックする関数</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="kd">function</span><span class="w"> </span><span class="nx">isEmailAllowed</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">    </span><span class="c1">// 1. ALLOWED_EMAILS に含まれているかチェック</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">allowedEmails</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">email</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">  </span><span class="c1">// 許可</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">    </span><span class="c1">// 2. ALLOWED_DOMAINS のどれかで終わっているかチェック</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">domain</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">allowedDomains</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">email</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="nx">domain</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// endsWith = 「〜で終わる」</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">  </span><span class="c1">// 許可</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">  </span><span class="c1">// どちらにも該当しない → 拒否</span>
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="p">}</span>
</code></pre></div>
<p>このように、<strong>ログイン後にメールアドレスをチェックする処理がコードに組み込まれている</strong>ため、
環境変数を変更するだけでアクセス制限を変更できます。</p>
</blockquote>
<hr />
<blockquote>
<p><strong>シークレットとの違い</strong></p>
<table>
<thead>
<tr>
<th>種類</th>
<th>用途</th>
<th>画面での見え方</th>
</tr>
</thead>
<tbody>
<tr>
<td>環境変数</td>
<td>一般的な設定値</td>
<td><strong>そのまま見える</strong>（例: <code>user@example.com</code>）</td>
</tr>
<tr>
<td>シークレット</td>
<td>APIキーなど機密情報</td>
<td><strong>隠される</strong>（例: <code>••••••••</code>）</td>
</tr>
</tbody>
</table>
<p>メールアドレスやドメイン名は機密情報ではないので「環境変数」を使います。
APIキーなど漏れてはいけない情報は「シークレット」を使います。</p>
</blockquote>
<h6 id="_20">環境変数として公開されるシークレット<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h6>
<ol>
<li>「＋ シークレットを参照」をクリック</li>
<li>以下を設定:</li>
</ol>
<table>
<thead>
<tr>
<th>項目</th>
<th>設定値</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>名前1</td>
<td><code>OPENAI_API_KEY</code></td>
<td>コード内で使う環境変数名</td>
</tr>
<tr>
<td>シークレット</td>
<td><code>openai-api-key</code> を選択</td>
<td>Step 3で作成したシークレット</td>
</tr>
<tr>
<td>バージョン</td>
<td><code>1</code> または <code>latest</code></td>
<td>シークレットのバージョン</td>
</tr>
</tbody>
</table>
<ol>
<li>「完了」をクリック</li>
</ol>
<blockquote>
<p><strong>なぜシークレットを使うのか？</strong></p>
<table>
<thead>
<tr>
<th>方法</th>
<th>問題点</th>
</tr>
</thead>
<tbody>
<tr>
<td>コードに直接APIキーを書く</td>
<td>GitHubなどに漏洩するリスク大</td>
</tr>
<tr>
<td>普通の環境変数に設定</td>
<td>GCP画面に<strong>平文で丸見え</strong></td>
</tr>
<tr>
<td><strong>シークレットを使う</strong></td>
<td>暗号化されて安全に保管 ✓</td>
</tr>
</tbody>
</table>
<p><strong>この画面でやっていること（3つの設定）</strong></p>
<table>
<thead>
<tr>
<th>項目</th>
<th>設定値</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>名前</strong></td>
<td><code>OPENAI_API_KEY</code></td>
<td>コード内で使う「呼び名」（変数名）</td>
</tr>
<tr>
<td><strong>シークレット</strong></td>
<td><code>openai-api-key</code></td>
<td>Step 3で作った「金庫の中身」</td>
</tr>
<tr>
<td><strong>バージョン</strong></td>
<td><code>latest</code></td>
<td>シークレットのどのバージョンを使うか</td>
</tr>
</tbody>
</table>
<p><strong>イメージ</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>金庫（Secret Manager）の中身 → 呼び名（環境変数）をつけて渡す
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a> openai-api-key        →  OPENAI_API_KEY という名前で
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>「sk-xxxxx...」            アプリに渡す
</code></pre></div></p>
<p>こうすることで、コード内では <code>process.env.OPENAI_API_KEY</code> と書くだけで、
安全に保管されたAPIキーを使えるようになります。</p>
<p><strong>補足: サービスアカウントについて</strong>
Cloud Run functionsでは、デフォルトのサービスアカウントが自動的に使用されます。
サービスアカウントとは「アプリ専用のGoogleアカウント」のようなもので、
アプリがSecret Managerにアクセスするための権限を持っています。
詳しくは <a href="../99_service_account/">99_service_account.md</a> を参照してください。</p>
</blockquote>
<ol>
<li>「コンテナを保存」をクリック</li>
</ol>
<h5 id="_21">セキュリティ タブ<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h5>
<p>「セキュリティ」タブをクリックして、サービスアカウントを設定します。</p>
<table>
<thead>
<tr>
<th>項目</th>
<th>設定値</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>サービス アカウント</td>
<td><code>firebase-adminsdk-xxxxx@[プロジェクトID].iam.gserviceaccount.com</code></td>
<td>Step 4-2で権限を付与したサービスアカウント</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>注意</strong>: Step 4-2 で権限付与したサービスアカウントを選択してください。
<code>Default compute service account</code> のままだとシークレットへのアクセス権限エラーが発生します。</p>
</blockquote>
<h3 id="5-4">5-4. ソースコードの設定<a class="headerlink" href="#5-4" title="Permanent link">&para;</a></h3>
<p>「ソース」セクションで以下を設定：</p>
<h4 id="_22">ソースの場所<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>項目</th>
<th>設定値</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>ソースの場所</td>
<td><strong>インラインエディタ</strong></td>
<td>GCPコンソール上で直接コードを入力</td>
</tr>
</tbody>
</table>
<h4 id="_23">エントリポイント（重要）<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>項目</th>
<th>設定値</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>エントリポイント</td>
<td><strong><code>app</code></strong></td>
<td>最初に呼び出される関数名</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>エントリポイントとは？</strong></p>
<p>プログラムの「入口」です。リクエストが来た時に<strong>最初に実行される関数の名前</strong>を指定します。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>【エントリポイントの仕組み】
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>ユーザーがアクセス
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>    ↓
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>Cloud Run: 「エントリポイントは &#39;app&#39; だな」
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>    ↓
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>コード内の functions.http(&#39;app&#39;, ...) を実行
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>    ↓
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>処理開始
</code></pre></div>
<p><strong>コードとの対応（backend.js）</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1">// backend.js の中身（抜粋）</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="nx">functions</span><span class="p">.</span><span class="nx">http</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="c1">//              ↑</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="c1">//     この &#39;app&#39; がエントリポイント名</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="c1">//     GCPの設定と一致させる必要がある</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="p">});</span>
</code></pre></div>
<p><strong>間違えやすいポイント</strong></p>
<table>
<thead>
<tr>
<th>設定箇所</th>
<th>設定値</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>GCPコンソール → エントリポイント</td>
<td><code>app</code></td>
<td>GCPに教える「入口の名前」</td>
</tr>
<tr>
<td>backend.js → <code>functions.http('app', ...)</code></td>
<td><code>app</code></td>
<td>コード内で定義した「入口の名前」</td>
</tr>
</tbody>
</table>
<p><strong>この2つが一致していないとエラーになります。</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>エラー例: Function &#39;helloWorld&#39; is not defined
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>原因: GCPでは &#39;helloWorld&#39; を探しているが、コードには &#39;app&#39; しかない
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>対処: エントリポイントを &#39;app&#39; に変更
</code></pre></div>
</blockquote>
<h4 id="_24">ソースコード<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h4>
<blockquote>
<p><strong>言語の選択</strong></p>
<p>Node.js版とPython版を用意しています。どちらでも同じ機能が動作します。</p>
<table>
<thead>
<tr>
<th>言語</th>
<th>ソースコード</th>
<th>特徴</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Node.js</strong>（推奨）</td>
<td><a href="../../code/nodejs/">コードを見る</a></td>
<td>JavaScript。ウェブ開発で最も一般的</td>
</tr>
<tr>
<td>Python</td>
<td><a href="../../code/python/">コードを見る</a></td>
<td>AIや機械学習でよく使われる言語</td>
</tr>
</tbody>
</table>
<p>以下の手順は<strong>Node.js版</strong>で説明します。Python版を使う場合は、ランタイムを「Python 3.11」に変更し、<code>main.py</code>にbackend.pyの内容を貼り付けてください。</p>
<p><strong>ファイル構成（Node.js版）</strong></p>
<table>
<thead>
<tr>
<th>ファイル</th>
<th>役割</th>
<th>GCPでの操作</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="../../code/nodejs/front/">front.html</a></td>
<td>画面のデザイン（HTML/CSS）</td>
<td>新規ファイルとして追加</td>
</tr>
<tr>
<td><a href="../../code/nodejs/script/">script.js</a></td>
<td>フロントエンドの処理（JavaScript）</td>
<td>新規ファイルとして追加</td>
</tr>
<tr>
<td><a href="../../code/nodejs/backend/">backend.js</a></td>
<td>サーバー側の処理</td>
<td>index.js に貼り付け</td>
</tr>
<tr>
<td><a href="../../code/nodejs/package/">package.json</a></td>
<td>使用するライブラリ一覧</td>
<td>package.json に貼り付け</td>
</tr>
</tbody>
</table>
</blockquote>
<h5 id="gcp_1">GCPへの貼り付け手順<a class="headerlink" href="#gcp_1" title="Permanent link">&para;</a></h5>
<p><strong>1. index.js を設定</strong></p>
<ol>
<li>左側のファイル一覧で「index.js」をクリック</li>
<li>既存のコードをすべて削除</li>
<li><a href="../../code/nodejs/backend/">backend.js</a> の内容をコピーして貼り付け</li>
</ol>
<p><strong>2. front.html を追加</strong></p>
<ol>
<li>左側のファイル一覧の上にある「<strong>＋</strong>」ボタンをクリック</li>
<li>ファイル名に「<code>front.html</code>」と入力</li>
<li><a href="../../code/nodejs/front/">front.html</a> の内容をコピーして貼り付け</li>
</ol>
<p><strong>3. script.js を追加</strong></p>
<ol>
<li>左側のファイル一覧の上にある「<strong>＋</strong>」ボタンをクリック</li>
<li>ファイル名に「<code>script.js</code>」と入力</li>
<li><a href="../../code/nodejs/script/">script.js</a> の内容をコピーして貼り付け</li>
</ol>
<blockquote>
<p><strong>重要: Firebase設定の書き換え</strong></p>
<p>script.js 内の <code>firebaseConfig</code> を、Step 2-3でメモした自分のプロジェクトの設定に書き換えてください。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="kd">const</span><span class="w"> </span><span class="nx">firebaseConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="w">    </span><span class="nx">apiKey</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;AIzaSy...&quot;</span><span class="p">,</span><span class="w">           </span><span class="c1">// ← 自分の値に書き換え</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="w">    </span><span class="nx">authDomain</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;xxx.firebaseapp.com&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1">// ← 自分の値に書き換え</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="w">    </span><span class="nx">projectId</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;your-project-id&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1">// ← 自分の値に書き換え</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="p">};</span>
</code></pre></div>
</blockquote>
<p><strong>4. package.json を設定</strong></p>
<ol>
<li>左側のファイル一覧で「package.json」をクリック</li>
<li>既存の内容をすべて削除</li>
<li><a href="../../code/nodejs/package/">package.json</a> の内容をコピーして貼り付け</li>
</ol>
<h3 id="5-5">5-5. デプロイ<a class="headerlink" href="#5-5" title="Permanent link">&para;</a></h3>
<ol>
<li>画面下部の「作成」または「デプロイ」ボタンをクリック</li>
<li>デプロイが完了するまで待機（2〜5分程度）</li>
</ol>
<blockquote>
<p><strong>デプロイ中の画面</strong>
- 青い円が回転している: デプロイ中
- 緑のチェックマーク: デプロイ成功
- 赤い×マーク: デプロイ失敗（ログを確認してください）</p>
</blockquote>
<h3 id="5-6-url">5-6. 関数URLの確認<a class="headerlink" href="#5-6-url" title="Permanent link">&para;</a></h3>
<ol>
<li>デプロイ完了後、作成した関数名（<code>ai-chat-app</code>）をクリック</li>
<li>画面上部に表示されるURLをメモ</li>
<li>例: <code>https://ai-chat-app-xxxxx-an.a.run.app</code></li>
<li>このURLをブラウザで開くと、ログイン画面が表示されます</li>
</ol>
<blockquote>
<p><strong>独自ドメインを使いたい場合</strong>
本番環境で <code>app.yourcompany.co.jp</code> のような独自ドメインを使いたい場合は、
<a href="../99_custom_domain/">99_custom_domain.md</a> を参照してください。</p>
</blockquote>
<h3 id="5-7-firebase">5-7. Firebase認証済みドメインの追加（重要）<a class="headerlink" href="#5-7-firebase" title="Permanent link">&para;</a></h3>
<p>Cloud RunのURLでGoogleログインを使用するには、<strong>承認済みドメインへの追加が必須</strong>です。</p>
<h4 id="_25">なぜ必要か？<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h4>
<p>Firebase Authenticationは、セキュリティ上の理由から<strong>OAuth認証を許可するドメインを制限</strong>しています。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>【承認済みドメインがない場合】
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>悪意のあるサイト（evil.com）
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>    ↓
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>あなたのFirebase認証を埋め込もうとする
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>    ↓
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>Firebase: 「evil.comは許可リストにないので拒否！」
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>    ↓
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>ユーザーの認証情報が盗まれることを防止
</code></pre></div>
<p>つまり、<strong>あなたのCloud Run URLも許可リストに追加しないと、正規のサイトでもログインできません</strong>。</p>
<h4 id="_26">設定手順<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h4>
<ol>
<li>Firebaseコンソール → <strong>Authentication</strong> → <strong>Settings</strong></li>
<li><strong>「承認済みドメイン」</strong> タブをクリック</li>
<li><strong>「ドメインを追加」</strong> をクリック</li>
<li>Cloud RunのURL（ホスト名部分のみ）を入力:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>ai-chat-app-xxxxx-an.a.run.app
</code></pre></div>
   ※ <code>https://</code> は含めない</li>
<li>「追加」をクリック</li>
</ol>
<blockquote>
<p><strong>デフォルトで許可されているドメイン</strong></p>
<table>
<thead>
<tr>
<th>ドメイン</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>localhost</code></td>
<td>ローカル開発用</td>
</tr>
<tr>
<td><code>xxx.firebaseapp.com</code></td>
<td>Firebaseのデフォルトドメイン</td>
</tr>
<tr>
<td><code>xxx.web.app</code></td>
<td>Firebase Hostingのドメイン</td>
</tr>
</tbody>
</table>
<p>Cloud RunのURLは<strong>自動では追加されない</strong>ため、手動で追加が必要です。</p>
</blockquote>
<hr />
<h2 id="step-6-5">Step 6: 動作確認（5分）<a class="headerlink" href="#step-6-5" title="Permanent link">&para;</a></h2>
<h3 id="6-1">6-1. アクセス確認<a class="headerlink" href="#6-1" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>URL</th>
<th>期待する結果</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>https://[関数URL]/</code></td>
<td>ログイン画面が表示される</td>
</tr>
<tr>
<td><code>https://[関数URL]/api/health</code></td>
<td><code>{"status":"ok","timestamp":"..."}</code> が表示される</td>
</tr>
</tbody>
</table>
<h3 id="6-2">6-2. ログインテスト<a class="headerlink" href="#6-2" title="Permanent link">&para;</a></h3>
<ol>
<li>「Googleでログイン」ボタンをクリック</li>
<li>Googleアカウントを選択</li>
<li>ログイン成功後、チャット画面が表示される</li>
</ol>
<h3 id="6-3">6-3. チャットテスト<a class="headerlink" href="#6-3" title="Permanent link">&para;</a></h3>
<ol>
<li>チャット画面でメッセージを入力</li>
<li>「送信」ボタンをクリック</li>
<li>AIからの回答が表示されれば成功</li>
</ol>
<blockquote>
<p><strong>ダミーAPIキーを使用している場合</strong>
<code>/api/health</code> は成功しますが、チャットは「AIの処理中にエラーが発生しました」と表示されます。
本番のOpenAI APIキーを設定すれば、チャットも動作します。</p>
</blockquote>
<hr />
<h2 id="_27">完了チェック<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th style="text-align: center;">チェック</th>
<th>確認項目</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">☐</td>
<td>関数URLにアクセスしてログイン画面が表示される</td>
</tr>
<tr>
<td style="text-align: center;">☐</td>
<td>Googleアカウントでログインできる</td>
</tr>
<tr>
<td style="text-align: center;">☐</td>
<td>ログイン後、チャット画面が表示される</td>
</tr>
<tr>
<td style="text-align: center;">☐</td>
<td><code>/api/health</code> で <code>{"status":"ok"}</code> が表示される</td>
</tr>
<tr>
<td style="text-align: center;">☐</td>
<td>ブラウザに鍵マーク（HTTPS）が表示される</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="_28">トラブルシューティング<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h2>
<h3 id="cloud-run-functions">Cloud Run functionsのデプロイが失敗する<a class="headerlink" href="#cloud-run-functions" title="Permanent link">&para;</a></h3>
<ul>
<li>Cloud Build APIが有効になっているか確認</li>
<li>コードにエラーがないか確認（インデントのずれ等）</li>
<li>ログを確認: Cloud Run →「ログ」タブ</li>
</ul>
<h3 id="status-ok">「{"status": "ok"}」が表示されない<a class="headerlink" href="#status-ok" title="Permanent link">&para;</a></h3>
<ul>
<li>関数が正常にデプロイされているか確認（緑のチェックマーク）</li>
<li>「未認証の呼び出しを許可」が選択されているか確認</li>
<li>関数URLが正しいか確認</li>
</ul>
<h3 id="_29">チャットでエラーが出る<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h3>
<ul>
<li>OpenAI APIキーが正しく設定されているか確認</li>
<li>Secret Managerのシークレット名が <code>openai-api-key</code> になっているか確認</li>
<li>環境変数名が <code>OPENAI_API_KEY</code> になっているか確認</li>
</ul>
<h3 id="cors">CORSエラーが出る<a class="headerlink" href="#cors" title="Permanent link">&para;</a></h3>
<ul>
<li>コード内のCORS設定が正しいか確認</li>
<li><code>Access-Control-Allow-Origin: *</code> が設定されているか確認</li>
</ul>
<hr />
<h2 id="url">重要なURL<a class="headerlink" href="#url" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>サービス</th>
<th>URL</th>
</tr>
</thead>
<tbody>
<tr>
<td>GCPコンソール</td>
<td>https://console.cloud.google.com</td>
</tr>
<tr>
<td>Firebaseコンソール</td>
<td>https://console.firebase.google.com</td>
</tr>
<tr>
<td>OpenAI APIキー取得</td>
<td>https://platform.openai.com/api-keys</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="_30">本番運用時のセキュリティ設定<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h2>
<p>本番環境で運用する際は、以下の設定を必ず行ってください。</p>
<h3 id="_31">必須設定<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>項目</th>
<th>現状（開発用）</th>
<th>本番設定</th>
</tr>
</thead>
<tbody>
<tr>
<td>CORS設定</td>
<td><code>'*'</code>（全許可）</td>
<td>自分のドメインのみ許可に変更</td>
</tr>
<tr>
<td>ALLOWED設定</td>
<td>未設定（全員許可）</td>
<td><code>ALLOWED_EMAILS</code> または <code>ALLOWED_DOMAINS</code> を必ず設定</td>
</tr>
<tr>
<td>Firebase設定</td>
<td>サンプル値</td>
<td>自分のプロジェクトの値に書き換え</td>
</tr>
</tbody>
</table>
<h4 id="cors_1">CORS設定の変更方法<a class="headerlink" href="#cors_1" title="Permanent link">&para;</a></h4>
<p><code>backend.js</code> の以下の部分を変更します：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1">// 変更前（開発用）</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="kd">const</span><span class="w"> </span><span class="nx">ALLOWED_ORIGINS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">];</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="c1">// 変更後（本番用）- 自分のドメインのみ許可</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="kd">const</span><span class="w"> </span><span class="nx">ALLOWED_ORIGINS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">    </span><span class="s1">&#39;https://your-app.web.app&#39;</span><span class="p">,</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">    </span><span class="s1">&#39;https://your-domain.com&#39;</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="p">];</span>
</code></pre></div>
<h4 id="_32">アクセス制限の設定<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h4>
<p>GCPの環境変数で以下を設定します：</p>
<table>
<thead>
<tr>
<th>環境変数</th>
<th>設定例</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ALLOWED_EMAILS</code></td>
<td><code>admin@example.com,user1@example.com</code></td>
<td>許可するメールアドレス（カンマ区切り）</td>
</tr>
<tr>
<td><code>ALLOWED_DOMAINS</code></td>
<td><code>@yourcompany.co.jp</code></td>
<td>許可するドメイン（@を含む、カンマ区切り）</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>注意</strong>: 両方とも未設定の場合、開発用として全員がアクセスできる状態になります。
本番では必ずどちらかを設定してください。</p>
</blockquote>
<h3 id="_33">推奨設定（より安全に運用したい場合）<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>項目</th>
<th>説明</th>
<th>対応方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>JWT署名検証</td>
<td>トークンの改ざん防止を強化</td>
<td><code>firebase-admin</code> パッケージで検証を追加</td>
</tr>
<tr>
<td>レート制限</td>
<td>大量リクエスト攻撃の防止</td>
<td>Cloud Armor を設定</td>
</tr>
<tr>
<td>ログ監視</td>
<td>不正アクセスの検知</td>
<td>Cloud Logging でアラート設定</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>補足</strong>: 現在の実装でも基本的なセキュリティは確保されています。
上記は大規模運用や機密性の高いデータを扱う場合の追加対策です。</p>
</blockquote>
<hr />
<h2 id="_34">参考: 別のアーキテクチャパターン<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h2>
<p>より複雑なアプリケーションや長時間処理が必要な場合は、Cloud Runを使用する方法もあります。</p>
<p>詳細は <a href="../99_cloudrun/">99_cloudrun.md</a> を参照してください。</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  ページトップへ戻る
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.top", "search.highlight", "search.suggest", "content.code.copy", "toc.follow"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "\u30b3\u30d4\u30fc\u3057\u307e\u3057\u305f", "clipboard.copy": "\u30af\u30ea\u30c3\u30d7\u30dc\u30fc\u30c9\u3078\u30b3\u30d4\u30fc", "search.result.more.one": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3082\u30461\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.more.other": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3042\u3068#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.none": "\u4f55\u3082\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3067\u3057\u305f", "search.result.one": "1\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.other": "#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.placeholder": "\u691c\u7d22\u30ad\u30fc\u30ef\u30fc\u30c9\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044", "search.result.term.missing": "\u691c\u7d22\u306b\u542b\u307e\u308c\u306a\u3044", "select.version": "\u30d0\u30fc\u30b8\u30e7\u30f3\u5207\u308a\u66ff\u3048"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>