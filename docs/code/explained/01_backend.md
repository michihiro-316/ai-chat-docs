# backend.py è©³ç´°è§£èª¬

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚µãƒ¼ãƒãƒ¼å´ã®å‡¦ç†ã‚’æ‹…å½“ã—ã¾ã™ã€‚ã€Œå¨æˆ¿ã®ã‚·ã‚§ãƒ•ã€ã®ã‚ˆã†ãªå½¹å‰²ã§ã™ã€‚

**ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€Pythonã®åŸºç¤æ§‹æ–‡ã‹ã‚‰ä¸å¯§ã«è§£èª¬ã—ã¾ã™ã€‚**

---

## ç›®æ¬¡ { data-toc-skip }

1. [PythonåŸºç¤ï¼šã“ã‚Œã ã‘è¦šãˆã‚ˆã†](#1-pythonåŸºç¤ã“ã‚Œã ã‘è¦šãˆã‚ˆã†)
2. [ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿](#2-ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿)
3. [è¨­å®šéƒ¨åˆ†](#3-è¨­å®šéƒ¨åˆ†)
4. [ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°](#4-ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°)
5. [ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡](#5-ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡)
6. [ãƒ¡ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒ©](#6-ãƒ¡ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒ©)

---

## 1. PythonåŸºç¤ï¼šã“ã‚Œã ã‘è¦šãˆã‚ˆã†

ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€å‰ã«ã€å¿…è¦ãªPythonæ§‹æ–‡ã‚’è§£èª¬ã—ã¾ã™ã€‚

### 1-1. è¾æ›¸ï¼ˆdictionaryï¼‰ã¨ã¯ï¼Ÿ

**è¾æ›¸ = ã€Œåå‰ã€ã¨ã€Œå€¤ã€ã®ãƒšã‚¢ã‚’ä¿å­˜ã™ã‚‹ã‚‚ã®**

```python
# è¾æ›¸ã‚’ä½œã‚‹
person = {
    'name': 'ç”°ä¸­',
    'age': 25,
    'email': 'tanaka@example.com'
}

# å€¤ã‚’å–ã‚Šå‡ºã™
print(person['name'])   # â†’ ç”°ä¸­
print(person['age'])    # â†’ 25

# å€¤ã‚’è¿½åŠ ãƒ»å¤‰æ›´ã™ã‚‹
person['phone'] = '090-1234-5678'  # è¿½åŠ 
person['age'] = 26                  # å¤‰æ›´
```

!!! tip "ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼šè¾æ›¸ = å¼•ãå‡ºã—ã«åå‰ãƒ©ãƒ™ãƒ«ãŒã¤ã„ãŸæ£š"

    | ãƒ©ãƒ™ãƒ«ï¼ˆã‚­ãƒ¼ï¼‰ | name | age | email |
    |---------------|------|-----|-------|
    | ä¸­èº«ï¼ˆå€¤ï¼‰ | ç”°ä¸­ | 25 | tanaka@.. |

    `person['name']` â†’ ã€Œnameãƒ©ãƒ™ãƒ«ã®å¼•ãå‡ºã—ã‚’é–‹ã‘ã¦ä¸­èº«ã‚’è¦‹ã‚‹ã€

**ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã®ä½¿ã‚ã‚Œæ–¹**
```python
# headers ã¨ã„ã†è¾æ›¸ã«å€¤ã‚’è¿½åŠ ã—ã¦ã„ã
headers = {}  # ç©ºã®è¾æ›¸ã‚’ä½œã‚‹
headers['Content-Type'] = 'text/html'  # è¿½åŠ 
headers['X-Frame-Options'] = 'DENY'    # è¿½åŠ 

# çµæœ
# headers = {
#     'Content-Type': 'text/html',
#     'X-Frame-Options': 'DENY'
# }
```

---

### 1-2. in æ¼”ç®—å­

**in = ã€Œã€œã®ä¸­ã«å«ã¾ã‚Œã‚‹ï¼Ÿã€ã‚’ç¢ºèªã™ã‚‹**

```python
# ãƒªã‚¹ãƒˆï¼ˆé…åˆ—ï¼‰ã§ã®ä½¿ç”¨
fruits = ['ã‚Šã‚“ã”', 'ã¿ã‹ã‚“', 'ã¶ã©ã†']

'ã‚Šã‚“ã”' in fruits    # â†’ Trueï¼ˆå«ã¾ã‚Œã‚‹ï¼‰
'ãƒãƒŠãƒŠ' in fruits    # â†’ Falseï¼ˆå«ã¾ã‚Œãªã„ï¼‰

# æ–‡å­—åˆ—ã§ã®ä½¿ç”¨
email = 'tanaka@example.com'

'@' in email          # â†’ Trueï¼ˆ@ãŒå«ã¾ã‚Œã‚‹ï¼‰
'@example.com' in email  # â†’ True
'@test.com' in email     # â†’ False
```

**ifæ–‡ã§ã®ä½¿ã„æ–¹**
```python
allowed_list = ['tanaka@example.com', 'yamada@test.com']
email = 'tanaka@example.com'

if email in allowed_list:
    print('è¨±å¯ã•ã‚Œã¦ã„ã¾ã™')
else:
    print('è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“')

# â†’ è¨±å¯ã•ã‚Œã¦ã„ã¾ã™
```

---

### 1-3. `or` ã¨ã¯ï¼Ÿ

**`or` = ã€Œã¾ãŸã¯ã€ï¼ˆã©ã¡ã‚‰ã‹ãŒTrueãªã‚‰Trueï¼‰**

```python
# æ¡ä»¶ã§ã®ä½¿ç”¨
age = 20
is_student = True

if age >= 18 or is_student:
    print('OK')  # ã©ã¡ã‚‰ã‹ãŒTrueãªã®ã§OK

# â†’ OK
```

**å€¤ã®é¸æŠã§ã®ä½¿ç”¨ï¼ˆã“ã‚ŒãŒé‡è¦ï¼ï¼‰**
```python
# ã€Œå€¤ or ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã€ã¨ã„ã†æ›¸ãæ–¹
name = None
result = name or 'åç„¡ã—'
print(result)  # â†’ 'åç„¡ã—'

name = 'ç”°ä¸­'
result = name or 'åç„¡ã—'
print(result)  # â†’ 'ç”°ä¸­'
```

!!! info "ä»•çµ„ã¿ï¼šA or B ã®å‹•ã"

    1. ã¾ãš A ã‚’ç¢ºèª
    2. A ãŒã€Œã‚ã‚‹ã€ï¼ˆTrueç›¸å½“ï¼‰ãªã‚‰ â†’ **A ã‚’è¿”ã™**
    3. A ãŒã€Œãªã„ã€ï¼ˆFalseç›¸å½“ï¼‰ãªã‚‰ â†’ **B ã‚’è¿”ã™**

    **ä¾‹ï¼š**

    - `origin = None` ã®å ´åˆï¼š`origin or '*'` â†’ `'*'` ã‚’è¿”ã™
    - `origin = 'https://example.com'` ã®å ´åˆï¼š`origin or '*'` â†’ `'https://example.com'` ã‚’è¿”ã™

---

### 1-4. `with open()` ã¨ã¯ï¼Ÿ

**`with open()` = ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®‰å…¨ã«é–‹ã„ã¦èª­ã‚€æ–¹æ³•**

```python
with open('front.html', 'r', encoding='utf-8') as f:
    content = f.read()
```

!!! note "å„éƒ¨åˆ†ã®æ„å‘³"

    ```
    with open('front.html', 'r', encoding='utf-8') as f:
    ```

    | éƒ¨åˆ† | æ„å‘³ |
    |------|------|
    | `open` | ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãé–¢æ•° |
    | `'front.html'` | ãƒ•ã‚¡ã‚¤ãƒ«å |
    | `'r'` | readï¼ˆèª­ã¿å–ã‚Šï¼‰ |
    | `encoding='utf-8'` | æ–‡å­—ã‚³ãƒ¼ãƒ‰ï¼ˆæ—¥æœ¬èªå¯¾å¿œï¼‰ |
    | `as f` | å¤‰æ•°åï¼ˆä½•ã§ã‚‚OKï¼‰ |

    ```
    content = f.read()
    ```

    - `f.read()` â†’ ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’å…¨éƒ¨èª­ã‚€
    - `content` â†’ èª­ã‚“ã å†…å®¹ã‚’å¤‰æ•°ã«ä¿å­˜

**ãªãœ `with` ã‚’ä½¿ã†ï¼Ÿ**
```python
# æ‚ªã„ä¾‹ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‰ã˜å¿˜ã‚Œã‚‹å¯èƒ½æ€§ï¼‰
f = open('file.txt', 'r')
content = f.read()
f.close()  # é–‰ã˜å¿˜ã‚Œã‚‹ã¨å•é¡ŒãŒèµ·ãã‚‹ï¼

# è‰¯ã„ä¾‹ï¼ˆwithã‚’ä½¿ã†ã¨è‡ªå‹•ã§é–‰ã˜ã¦ãã‚Œã‚‹ï¼‰
with open('file.txt', 'r') as f:
    content = f.read()
# â† ã“ã“ã§è‡ªå‹•çš„ã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒé–‰ã˜ã‚‰ã‚Œã‚‹
```

!!! example "ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼šwith = è‡ªå‹•ã§ç‰‡ä»˜ã‘ã¦ãã‚Œã‚‹ä»•çµ„ã¿"

    **ä¾‹ï¼šå†·è”µåº«ã‚’é–‹ã‘ã¦é£Ÿæã‚’å–ã‚Šå‡ºã™**

    | æ–¹æ³• | æµã‚Œ |
    |------|------|
    | æ™®é€š | å†·è”µåº«ã‚’é–‹ã‘ã‚‹ â†’ é£Ÿæã‚’å–ã‚‹ â†’ **é–‰ã‚å¿˜ã‚Œã‚‹ï¼** |
    | with | å†·è”µåº«ã‚’é–‹ã‘ã‚‹ â†’ é£Ÿæã‚’å–ã‚‹ â†’ **è‡ªå‹•ã§é–‰ã¾ã‚‹** |

---

### 1-5. Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ãƒ»ãƒ‡ã‚³ãƒ¼ãƒ‰ã¨ã¯ï¼Ÿ

- **ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰** = ãƒ‡ãƒ¼ã‚¿ã‚’åˆ¥ã®å½¢å¼ã«å¤‰æ›ã™ã‚‹ã“ã¨
- **ãƒ‡ã‚³ãƒ¼ãƒ‰** = å¤‰æ›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å…ƒã«æˆ»ã™ã“ã¨

!!! example "æ—¥å¸¸ã®ä¾‹ï¼šæš—å·ã”ã£ã“"

    | ã‚¹ãƒ†ãƒƒãƒ— | ãƒ‡ãƒ¼ã‚¿ |
    |---------|--------|
    | å…ƒã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | ã€Œã“ã‚“ã«ã¡ã¯ã€ |
    | â†“ ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆå¤‰æ›ï¼‰ | |
    | å¤‰æ›å¾Œ | `44GT44KT44Gr44Gh44Gv` â† èª­ã‚ãªã„ï¼ |
    | â†“ ãƒ‡ã‚³ãƒ¼ãƒ‰ï¼ˆå¾©å…ƒï¼‰ | |
    | å¾©å…ƒå¾Œ | ã€Œã“ã‚“ã«ã¡ã¯ã€ â† å…ƒã«æˆ»ã£ãŸï¼ |

!!! info "ãªãœBase64ã‚’ä½¿ã†ï¼Ÿ"

    **JWTãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆãƒ­ã‚°ã‚¤ãƒ³è¨¼æ˜æ›¸ï¼‰ã¯3ã¤ã®éƒ¨åˆ†ã‹ã‚‰ã§ãã¦ã„ã‚‹**

    ```
    eyJhbGci... . eyJlbWFpbCI... . SflKxwRJ...
    ```

    | éƒ¨åˆ† | åå‰ | å½¹å‰² |
    |------|------|------|
    | 1ç•ªç›® | ãƒ˜ãƒƒãƒ€ãƒ¼ | å½¢å¼æƒ…å ± |
    | 2ç•ªç›® | ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ | ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆ**ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒBase64ã§å…¥ã£ã¦ã„ã‚‹**ï¼‰ |
    | 3ç•ªç›® | ç½²å | æ”¹ã–ã‚“é˜²æ­¢ |

**å…·ä½“ä¾‹**
```python
import base64
import json

# JWTãƒˆãƒ¼ã‚¯ãƒ³ã®ä¾‹ï¼ˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰éƒ¨åˆ†ï¼‰
encoded = "eyJlbWFpbCI6InRhbmFrYUBleGFtcGxlLmNvbSIsIm5hbWUiOiLnlLDkuK0ifQ"

# ã‚¹ãƒ†ãƒƒãƒ—1: Base64ãƒ‡ã‚³ãƒ¼ãƒ‰
decoded_bytes = base64.urlsafe_b64decode(encoded + '==')
# â†’ b'{"email":"tanaka@example.com","name":"\xe7\x94\xb0\xe4\xb8\xad"}'

# ã‚¹ãƒ†ãƒƒãƒ—2: æ–‡å­—åˆ—ã«å¤‰æ›
decoded_str = decoded_bytes.decode('utf-8')
# â†’ '{"email":"tanaka@example.com","name":"ç”°ä¸­"}'

# ã‚¹ãƒ†ãƒƒãƒ—3: JSONã¨ã—ã¦è§£æ
data = json.loads(decoded_str)
# â†’ {'email': 'tanaka@example.com', 'name': 'ç”°ä¸­'}

# ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–ã‚Šå‡ºã™
email = data.get('email')
# â†’ 'tanaka@example.com'
```

**å›³è§£**
```
eyJlbWFpbCI6InRhbmFrYUBleGFtcGxlLmNvbSIsIm5hbWUiOiLnlLDkuK0ifQ
                            â†“
                    Base64ãƒ‡ã‚³ãƒ¼ãƒ‰
                            â†“
{"email":"tanaka@example.com","name":"ç”°ä¸­"}
                            â†“
                    JSONã¨ã—ã¦è§£æ
                            â†“
                    email ã‚’å–ã‚Šå‡ºã™
                            â†“
                 tanaka@example.com
```

---

## 2. ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿

```python
import os
import json
import base64
from datetime import datetime
import functions_framework
from openai import OpenAI
```

### å„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å½¹å‰²

| ãƒ©ã‚¤ãƒ–ãƒ©ãƒª | å½¹å‰² | ä½¿ã†å ´é¢ |
|-----------|------|---------|
| `os` | ç’°å¢ƒå¤‰æ•°ã‚’èª­ã‚€ | APIã‚­ãƒ¼ã‚„è¨±å¯ãƒªã‚¹ãƒˆã®å–å¾— |
| `json` | JSONãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã† | ãƒˆãƒ¼ã‚¯ãƒ³è§£æã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä½œæˆ |
| `base64` | ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ã™ã‚‹ | JWTãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒ‡ã‚³ãƒ¼ãƒ‰ |
| `datetime` | æ—¥æ™‚ã‚’æ‰±ã† | ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®æ™‚åˆ»è¡¨ç¤º |
| `functions_framework` | Cloud Runå¯¾å¿œ | HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚‹ |
| `openai` | ChatGPT API | AIã«è³ªå•ã‚’é€ã‚‹ |

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å…¨ä½“åƒï¼ˆãªãœå®‰å…¨ï¼Ÿï¼‰

ã‚³ãƒ¼ãƒ‰ã®è©³ç´°ã«å…¥ã‚‹å‰ã«ã€**ã“ã®ã‚·ã‚¹ãƒ†ãƒ ãŒã©ã†å®ˆã‚‰ã‚Œã¦ã„ã‚‹ã‹**ã‚’ç†è§£ã—ã¾ã—ã‚‡ã†ã€‚

### ã¾ãšçŸ¥ã£ã¦ãŠãã“ã¨ï¼šHTTPé€šä¿¡ã®åŸºæœ¬

#### ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹

ãƒ–ãƒ©ã‚¦ã‚¶ã¨ã‚µãƒ¼ãƒãƒ¼ã¯ã€Œæ‰‹ç´™ã®ã‚„ã‚Šã¨ã‚Šã€ã®ã‚ˆã†ã«é€šä¿¡ã—ã¾ã™ã€‚

```text
ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆãŠé¡˜ã„ï¼‰ã€‘
ãƒ–ãƒ©ã‚¦ã‚¶  ------>  ã‚µãƒ¼ãƒãƒ¼
         ã€Œ/api/chat ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãã ã•ã„ã€

ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆè¿”äº‹ï¼‰ã€‘
ãƒ–ãƒ©ã‚¦ã‚¶  <------  ã‚µãƒ¼ãƒãƒ¼
         ã€Œã¯ã„ã€ã©ã†ãã€
```

#### ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã¯ã€Œ2ã¤ã®éƒ¨åˆ†ã€ãŒã‚ã‚‹

ã‚µãƒ¼ãƒãƒ¼ãŒãƒ–ãƒ©ã‚¦ã‚¶ã«è¿”ã™ã€Œè¿”äº‹ã€ã¯ã€ä»¥ä¸‹ã®æ§‹é€ ã«ãªã£ã¦ã„ã¾ã™ï¼š

```text
+------------------------------------------+
| ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã¸ã®æŒ‡ç¤ºæ›¸ï¼‰              |
|                                          |
|   Content-Type: application/json         |
|   X-Frame-Options: DENY                  |
|   Access-Control-Allow-Origin: ...       |
+------------------------------------------+
| ãƒœãƒ‡ã‚£ï¼ˆå®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ï¼‰                     |
|                                          |
|   {"message": "ã“ã‚“ã«ã¡ã¯"}               |
+------------------------------------------+
```

| éƒ¨åˆ† | å½¹å‰² | ä¾‹ |
|------|------|-----|
| **ãƒ˜ãƒƒãƒ€ãƒ¼** | ãƒ–ãƒ©ã‚¦ã‚¶ã¸ã®ã€ŒæŒ‡ç¤ºæ›¸ã€ | `X-Frame-Options: DENY` |
| **ãƒœãƒ‡ã‚£** | å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ | `{"message": "ã“ã‚“ã«ã¡ã¯"}` |

**ãƒ˜ãƒƒãƒ€ãƒ¼ = ã€Œã“ã®è¿”äº‹ã‚’ã“ã†æ‰±ã£ã¦ã­ã€ã¨ã„ã†ãƒ–ãƒ©ã‚¦ã‚¶ã¸ã®å‘½ä»¤**

#### ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã«å¾“ã†ï¼ˆä»•æ§˜ã§æ±ºã¾ã£ã¦ã„ã‚‹ï¼‰

```text
ã‚µãƒ¼ãƒãƒ¼: ã€ŒX-Frame-Options: DENYã€ï¼ˆiframeã«å…¥ã‚Œãªã„ã§ï¼‰
   |
   v
ãƒ–ãƒ©ã‚¦ã‚¶: ã€Œäº†è§£ã€ã“ã®ãƒšãƒ¼ã‚¸ã¯iframeã«å…¥ã‚Œã¾ã›ã‚“ã€
```

ã“ã‚Œã¯**ãƒ–ãƒ©ã‚¦ã‚¶ã®ä»•æ§˜ï¼ˆãƒ«ãƒ¼ãƒ«ï¼‰**ã§ã™ã€‚
Chromeã€Firefoxã€Edge ãªã©ã€ã™ã¹ã¦ã®ä¸»è¦ãƒ–ãƒ©ã‚¦ã‚¶ãŒã“ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã„ã¾ã™ã€‚

---

### CORSã¨ã¯ï¼Ÿï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã§åˆ¶å¾¡ã™ã‚‹ä»•çµ„ã¿ï¼‰

**CORS**ã¯ã€ã“ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½¿ã£ã¦ã€Œ**ã©ã®ã‚µã‚¤ãƒˆã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ã‹**ã€ã‚’åˆ¶å¾¡ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚

#### CORSã®å‹•ã

```text
evil.com (JavaScript)
   |
   |  your-app ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãã ã•ã„
   v
ã‚µãƒ¼ãƒãƒ¼ (your-app.run.app)
   |
   |  APIå‡¦ç†ä¸­...ï¼ˆã“ã“ã§èª²é‡‘ç™ºç”Ÿï¼ï¼‰
   |
   |  ãƒ¬ã‚¹ãƒãƒ³ã‚¹ + ãƒ˜ãƒƒãƒ€ãƒ¼:
   |  ã€Œyour-app.run.app ã ã‘ãŒãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Œã¾ã™ã€
   v
ãƒ–ãƒ©ã‚¦ã‚¶
   |
   |  evil.com ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã«æ›¸ã„ã¦ãªã„...
   v
ãƒ–ãƒ­ãƒƒã‚¯ï¼ï¼ˆãƒ‡ãƒ¼ã‚¿ã¯JavaScriptã«æ¸¡ã•ãªã„ï¼‰
```

ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¨˜è¼‰ãŒãªã„ã®ã§**ãƒ‡ãƒ¼ã‚¿ã¯æ¸¡ã•ãªã„**ï¼
ãã‚“ãªæ©Ÿèƒ½ã‚’æŒã¤ã®ãŒã€**CORS**ã§ã™ã€‚

!!! danger "é‡è¦ï¼šCORSã ã‘ã§ã¯èª²é‡‘ã¯é˜²ã’ãªã„"

    ä¸Šã®å›³ã‚’ã‚ˆãè¦‹ã¦ãã ã•ã„ã€‚

    - ã‚µãƒ¼ãƒãƒ¼ã¯**å‡¦ç†ã‚’å®Ÿè¡Œ**ã—ã¦ã„ã‚‹
    - ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚‚**è¿”ã—ã¦ã„ã‚‹**

    ã¤ã¾ã‚Š**APIã¯ä½¿ã‚ã‚Œã¦ã„ã‚‹ = èª²é‡‘ã¯ç™ºç”Ÿã™ã‚‹**ï¼

    CORSãŒé˜²ãã®ã¯ã€Œçµæœã‚’JavaScriptã«æ¸¡ã™ã“ã¨ã€ã ã‘ã€‚
    **å‡¦ç†è‡ªä½“ã¯æ­¢ã‚ã‚‰ã‚Œã¾ã›ã‚“ã€‚**

| ç–‘å• | ç­”ãˆ |
|------|------|
| CORSã¯ä½•ã‚’ã™ã‚‹ï¼Ÿ | è¨±å¯ã•ã‚Œã¦ãªã„ã‚µã‚¤ãƒˆã«ã¯ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã•ãªã„ |
| èª°ãŒåˆ¤æ–­ã™ã‚‹ï¼Ÿ | ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¦‹ã¦åˆ¤æ–­ï¼‰ |
| èª²é‡‘ã¯é˜²ã’ã‚‹ï¼Ÿ | **é˜²ã’ãªã„**ï¼ˆå‡¦ç†ã¯èµ°ã‚‹ï¼‰ |
| ã˜ã‚ƒã‚ä½•ã®ãŸã‚ï¼Ÿ | ãƒ‡ãƒ¼ã‚¿ã®**ç›—ã¿è¦‹**ã‚’é˜²ã |

!!! warning "ãƒ˜ãƒƒãƒ€ãƒ¼ã®é™ç•Œ"

    ãƒ˜ãƒƒãƒ€ãƒ¼ã§å®ˆã‚Œã‚‹ã®ã¯**ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹**ã ã‘ã§ã™ã€‚

    **ãƒ–ãƒ©ã‚¦ã‚¶ä»¥å¤–ã®ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•ï¼š**

    - **curl** = ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ãƒ„ãƒ¼ãƒ«
    - **Postman** = APIãƒ†ã‚¹ãƒˆç”¨ã®ã‚¢ãƒ—ãƒª

    ã“ã‚Œã‚‰ã¯**ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ãªã„**ã®ã§ã€CORSãƒ˜ãƒƒãƒ€ãƒ¼ã‚’**ç„¡è¦–ã§ãã¾ã™**ã€‚

    ```text
    ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆã€‘
    evil.com â†’ ãƒªã‚¯ã‚¨ã‚¹ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼ â†’ ãƒ¬ã‚¹ãƒãƒ³ã‚¹
                                    â†’ ãƒ˜ãƒƒãƒ€ãƒ¼ã€Œevil.comã¯ãƒ€ãƒ¡ã€
                                    â†’ ãƒ–ãƒ©ã‚¦ã‚¶ã€Œå¾“ã„ã¾ã™ã€â†’ ãƒ–ãƒ­ãƒƒã‚¯ âœ“

    ã€curl/Postmanã®å ´åˆã€‘
    curl â†’ ãƒªã‚¯ã‚¨ã‚¹ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼ â†’ ãƒ¬ã‚¹ãƒãƒ³ã‚¹
                              â†’ ãƒ˜ãƒƒãƒ€ãƒ¼ã€Œevil.comã¯ãƒ€ãƒ¡ã€
                              â†’ curlã€ŒçŸ¥ã‚‰ã‚“ãŒãªã€â†’ ãƒ‡ãƒ¼ã‚¿å–å¾— âœ—
    ```

    | ã‚¢ã‚¯ã‚»ã‚¹å…ƒ | ä½•ï¼Ÿ | ãƒ˜ãƒƒãƒ€ãƒ¼ã«å¾“ã†ï¼Ÿ | é˜²å¾¡ã§ãã‚‹ï¼Ÿ |
    |-----------|------|:---------------:|:-----------:|
    | ãƒ–ãƒ©ã‚¦ã‚¶ | Chromeã€Firefoxç­‰ | å¾“ã†ï¼ˆä»•æ§˜ï¼‰ | âœ“ |
    | curl | ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ« | ç„¡è¦–ã§ãã‚‹ | âœ— |
    | Postman | APIãƒ†ã‚¹ãƒˆã‚¢ãƒ—ãƒª | ç„¡è¦–ã§ãã‚‹ | âœ— |

    **ã¤ã¾ã‚Šï¼š**
    æ‚ªæ„ã®ã‚ã‚‹äººãŒcurlã‚„Postmanã‚’ä½¿ãˆã°ã€CORSã‚’ç„¡è¦–ã—ã¦APIã‚’å©ã‘ã¦ã—ã¾ã„ã¾ã™ã€‚
    ã ã‹ã‚‰**JWTæ¤œè¨¼ã‚„è¨±å¯ãƒªã‚¹ãƒˆ**ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ä»¥å¤–ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚‚é˜²ã„ã§ã„ã¾ã™ã€‚

---

### å¤šå±¤é˜²å¾¡ã®ä»•çµ„ã¿

CORSã ã‘ã§ã¯èª²é‡‘ã‚’é˜²ã’ãªã„ãŸã‚ã€ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯**è¤‡æ•°ã®é˜²å¾¡å±¤**ã§å®ˆã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

```text
ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆèª°ãŒã‚¢ã‚¯ã‚»ã‚¹ï¼Ÿï¼‰
         |
         v
+-------------------------------------+
| ç¬¬1å±¤ï¼šCORS                          |
| è¨±å¯ã•ã‚ŒãŸã‚µã‚¤ãƒˆã‹ã‚‰ï¼Ÿ                 |
| â†’ ã„ã„ãˆï¼šãƒ–ãƒ©ã‚¦ã‚¶ãŒãƒ‡ãƒ¼ã‚¿ã‚’ãƒ–ãƒ­ãƒƒã‚¯    |
+-------------------------------------+
         | ã¯ã„
         v
+-------------------------------------+
| ç¬¬2å±¤ï¼šJWTæ¤œè¨¼                        |
| ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ï¼Ÿ                     |
| â†’ ã„ã„ãˆï¼šã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ï¼ˆå‡¦ç†ã—ãªã„ï¼‰    |
+-------------------------------------+
         | ã¯ã„
         v
+-------------------------------------+
| ç¬¬3å±¤ï¼šè¨±å¯ãƒªã‚¹ãƒˆ                      |
| è¨±å¯ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼Ÿ                   |
| â†’ ã„ã„ãˆï¼šã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ï¼ˆå‡¦ç†ã—ãªã„ï¼‰    |
+-------------------------------------+
         | ã¯ã„
         v
+-------------------------------------+
| OpenAI APIå‘¼ã³å‡ºã—ï¼ˆã“ã“ã§èª²é‡‘ï¼ï¼‰     |
+-------------------------------------+
```

### å„å±¤ãŒçªç ´ã•ã‚Œã‚‹ã¨ä½•ãŒèµ·ãã‚‹ï¼Ÿ

| å±¤ | åå‰ | ä½•ã‚’å®ˆã‚‹ï¼Ÿ | çªç ´ã•ã‚Œã‚‹ã¨ï¼Ÿ |
|:--:|------|-----------|---------------|
| 1 | CORS | ä¸æ­£ã‚µã‚¤ãƒˆã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾— | ãƒ‡ãƒ¼ã‚¿ãŒç›—ã¾ã‚Œã‚‹å¯èƒ½æ€§ï¼ˆèª²é‡‘ã¯é˜²ã’ãªã„ï¼‰ |
| 2 | JWTæ¤œè¨¼ | æœªãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ | **å‹æ‰‹ã«APIã‚’ä½¿ã‚ã‚Œèª²é‡‘ã•ã‚Œã‚‹** |
| 3 | è¨±å¯ãƒªã‚¹ãƒˆ | éƒ¨å¤–è€…ã®ã‚¢ã‚¯ã‚»ã‚¹ | **å‹æ‰‹ã«APIã‚’ä½¿ã‚ã‚Œèª²é‡‘ã•ã‚Œã‚‹** |

!!! example "å…·ä½“ä¾‹ï¼šå„å±¤ãŒçªç ´ã•ã‚ŒãŸå ´åˆ"

    **ç¬¬1å±¤ï¼ˆCORSï¼‰ã ã‘çªç ´ã•ã‚ŒãŸå ´åˆï¼š**
    ```
    evil.com â†’ APIã‚’å©ã â†’ å‡¦ç†ã•ã‚Œã‚‹ â†’ èª²é‡‘ç™ºç”Ÿï¼
                                    â†’ ã§ã‚‚ãƒ‡ãƒ¼ã‚¿ã¯evil.comã«æ¸¡ã‚‰ãªã„
    ```
    â†’ èª²é‡‘ã•ã‚Œã‚‹ãŒã€ãƒ‡ãƒ¼ã‚¿ã¯å®ˆã‚‰ã‚Œã‚‹

    **ç¬¬2å±¤ï¼ˆJWTï¼‰ãŒçªç ´ã•ã‚ŒãŸå ´åˆï¼š**
    ```
    èª°ã§ã‚‚ â†’ ãƒ­ã‚°ã‚¤ãƒ³ãªã—ã§APIã‚’å©ã‘ã‚‹ â†’ ç„¡åˆ¶é™ã«èª²é‡‘ç™ºç”Ÿï¼
    ```
    â†’ å¤§é‡ã®ä¸æ­£åˆ©ç”¨ã§é«˜é¡è«‹æ±‚ã®å¯èƒ½æ€§

    **ç¬¬3å±¤ï¼ˆè¨±å¯ãƒªã‚¹ãƒˆï¼‰ãŒçªç ´ã•ã‚ŒãŸå ´åˆï¼š**
    ```
    éƒ¨å¤–è€… â†’ ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦APIã‚’ä½¿ãˆã‚‹ â†’ æƒ³å®šå¤–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèª²é‡‘
    ```
    â†’ æ„å›³ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹åˆ©ç”¨

### ãªãœ3å±¤ã™ã¹ã¦å¿…è¦ï¼Ÿ

```text
ã€CORSã ã‘ã®å ´åˆã€‘

evil.com â†’ ãƒªã‚¯ã‚¨ã‚¹ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼å‡¦ç† â†’ OpenAIå‘¼ã¶ â†’ èª²é‡‘ï¼
                                              â†“
                              ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”ã™ â†’ ãƒ–ãƒ©ã‚¦ã‚¶ãŒãƒ–ãƒ­ãƒƒã‚¯
                                              â†‘
                                   ã€Œè¦‹ã›ãªã„ã€ã ã‘ã§å‡¦ç†ã¯èµ°ã‚‹

ã€JWT + è¨±å¯ãƒªã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã€‘

evil.com â†’ ãƒªã‚¯ã‚¨ã‚¹ãƒˆ â†’ JWTæ¤œè¨¼ â†’ ãƒ€ãƒ¡ï¼â†’ ã‚¨ãƒ©ãƒ¼è¿”ã™
                          â†‘
                   ã“ã“ã§æ­¢ã¾ã‚‹ï¼ˆèª²é‡‘ã•ã‚Œãªã„ï¼‰
```

CORSã¯ã€Œãƒ–ãƒ©ã‚¦ã‚¶ãŒçµæœã‚’è¦‹ã›ãªã„ã€ã ã‘ã€‚
**ã‚µãƒ¼ãƒãƒ¼å´ã®å‡¦ç†ï¼ˆèª²é‡‘ï¼‰ã¯æ­¢ã‚ã‚‰ã‚Œã¾ã›ã‚“ã€‚**

ã ã‹ã‚‰**JWTæ¤œè¨¼ã¨è¨±å¯ãƒªã‚¹ãƒˆ**ã§ã€
**é«˜ä¾¡ãªå‡¦ç†ï¼ˆAIå‘¼ã³å‡ºã—ï¼‰ã®å‰ã«æ‹’å¦**ã—ã¦ã„ã¾ã™ã€‚

!!! tip "ã“ã®å¾Œã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€ãƒã‚¤ãƒ³ãƒˆ"

    | ã‚»ã‚¯ã‚·ãƒ§ãƒ³ | å¯¾å¿œã™ã‚‹é˜²å¾¡å±¤ | å®Ÿè¡Œé † |
    |-----------|---------------|:------:|
    | 4-1. set_cors_headers | ç¬¬1å±¤ï¼šCORS | 1 |
    | 5-2. get_email_from_token | ç¬¬2å±¤ï¼šJWTæ¤œè¨¼ | 2 |
    | 5-1. is_email_allowed | ç¬¬3å±¤ï¼šè¨±å¯ãƒªã‚¹ãƒˆ | 3 |

    â€» ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç•ªå·ã¨ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡Œé †ã¯ç•°ãªã‚Šã¾ã™ã€‚
    å®Ÿéš›ã®å‡¦ç†ã¯ã€ŒJWTæ¤œè¨¼ â†’ è¨±å¯ãƒªã‚¹ãƒˆã€ã®é †ç•ªã§è¡Œã‚ã‚Œã¾ã™ã€‚

---

## 3. è¨­å®šéƒ¨åˆ†

### ALLOWED_ORIGINS

```python
ALLOWED_ORIGINS = ['*']
```

**ã“ã‚Œã¯ä½•ï¼Ÿ**
- ã©ã®Webã‚µã‚¤ãƒˆã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹ã‹ã®ãƒªã‚¹ãƒˆ
- `'*'` = ã©ã“ã‹ã‚‰ã§ã‚‚OKï¼ˆé–‹ç™ºç”¨ï¼‰

---

### ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿

```python
with open('front.html', 'r', encoding='utf-8') as f:
    HTML_CONTENT = f.read()

with open('script.js', 'r', encoding='utf-8') as f:
    SCRIPT_CONTENT = f.read()
```

**ä½•ã‚’ã—ã¦ã„ã‚‹ï¼Ÿ**
1. `front.html` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
2. ä¸­èº«ã‚’å…¨éƒ¨èª­ã¿è¾¼ã‚€
3. `HTML_CONTENT` ã¨ã„ã†å¤‰æ•°ã«ä¿å­˜

**ãªãœæœ€åˆã«èª­ã¿è¾¼ã‚€ï¼Ÿ**
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãŸã³ã«èª­ã¿è¾¼ã‚€ã¨é…ããªã‚‹
- ä¸€åº¦èª­ã‚“ã§ãƒ¡ãƒ¢ãƒªã«ä¿å­˜ã—ã¦ãŠã

---

## 4. ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°

### 4-1. set_cors_headersï¼ˆCORSè¨­å®šï¼‰

```python
def set_cors_headers(headers, origin):
    if '*' in ALLOWED_ORIGINS or origin in ALLOWED_ORIGINS:
        headers['Access-Control-Allow-Origin'] = origin or '*'
    headers['Access-Control-Allow-Methods'] = 'GET, POST, OPTIONS'
    headers['Access-Control-Allow-Headers'] = 'Content-Type, Authorization'
    headers['Access-Control-Max-Age'] = '3600'
```

#### å¼•æ•°ã®èª¬æ˜

| å¼•æ•° | å‹ | èª¬æ˜ |
|------|-----|------|
| `headers` | è¾æ›¸ | ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ä»˜ã‘ã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ± |
| `origin` | æ–‡å­—åˆ— | ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…ƒã®URLï¼ˆä¾‹ï¼š`https://example.com`ï¼‰ |

#### 1è¡Œãšã¤è§£èª¬

**1è¡Œç›®ï¼šæ¡ä»¶åˆ¤å®š**
```python
if '*' in ALLOWED_ORIGINS or origin in ALLOWED_ORIGINS:
```

!!! note "ã“ã®æ¡ä»¶ã¯2ã¤ã®åˆ¤å®šã‚’ `or` ã§ç¹‹ã„ã§ã„ã‚‹"

    | åˆ¤å®š | å†…å®¹ | çµæœ |
    |------|------|------|
    | åˆ¤å®š1 | `'*' in ALLOWED_ORIGINS` â†’ ALLOWED_ORIGINS ã« '*' ãŒå«ã¾ã‚Œã‚‹ã‹ï¼Ÿ | `['*']` ãªã®ã§ True |
    | åˆ¤å®š2 | `origin in ALLOWED_ORIGINS` â†’ ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…ƒURLãŒè¨±å¯ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã‚‹ã‹ï¼Ÿ | URLæ¬¡ç¬¬ |

    `or` ã§ç¹‹ã„ã§ã„ã‚‹ã®ã§ã€**ã©ã¡ã‚‰ã‹ãŒTrueãªã‚‰ä¸­ã®å‡¦ç†ã‚’å®Ÿè¡Œ**

**2è¡Œç›®ï¼šãƒ˜ãƒƒãƒ€ãƒ¼ã«å€¤ã‚’è¨­å®š**
```python
headers['Access-Control-Allow-Origin'] = origin or '*'
```

!!! note "è§£èª¬"

    - `headers['ã‚­ãƒ¼å'] = å€¤` â†’ è¾æ›¸ã«å€¤ã‚’è¿½åŠ ã™ã‚‹æ›¸ãæ–¹
    - `origin or '*'` â†’ origin ã«å€¤ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†ã€‚None ã‚„ç©ºãªã‚‰ `'*'` ã‚’ä½¿ã†

    **ä¾‹ï¼š**

    | origin ã®å€¤ | çµæœ |
    |-------------|------|
    | `'https://example.com'` | `headers['Access-Control-Allow-Origin'] = 'https://example.com'` |
    | `None` | `headers['Access-Control-Allow-Origin'] = '*'` |

**3-5è¡Œç›®ï¼šå›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ã®è¨­å®š**
```python
headers['Access-Control-Allow-Methods'] = 'GET, POST, OPTIONS'
headers['Access-Control-Allow-Headers'] = 'Content-Type, Authorization'
headers['Access-Control-Max-Age'] = '3600'
```

| ãƒ˜ãƒƒãƒ€ãƒ¼ | å€¤ | æ„å‘³ |
|---------|-----|------|
| `Access-Control-Allow-Methods` | `'GET, POST, OPTIONS'` | ã“ã®3ã¤ã®HTTPãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¨±å¯ |
| `Access-Control-Allow-Headers` | `'Content-Type, Authorization'` | ã“ã®2ã¤ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨±å¯ |
| `Access-Control-Max-Age` | `'3600'` | ã“ã®è¨­å®šã‚’3600ç§’ï¼ˆ1æ™‚é–“ï¼‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ |

#### CORSã¨ã¯ï¼Ÿï¼ˆè©³ç´°è§£èª¬ï¼‰

**CORS = Cross-Origin Resource Sharingï¼ˆç•°ãªã‚‹ã‚ªãƒªã‚¸ãƒ³é–“ã®ãƒªã‚½ãƒ¼ã‚¹å…±æœ‰ï¼‰**

!!! tip "è±†çŸ¥è­˜ï¼šã‚ªãƒªã‚¸ãƒ³ï¼ˆOriginï¼‰ã¨ã¯ï¼Ÿ"

    ã‚ªãƒªã‚¸ãƒ³ã¯ã€Œ**ãƒ—ãƒ­ãƒˆã‚³ãƒ« + ãƒ‰ãƒ¡ã‚¤ãƒ³ + ãƒãƒ¼ãƒˆ**ã€ã®çµ„ã¿åˆã‚ã›ã§ã™ã€‚

    | è¦ç´  | èª¬æ˜ | ä¾‹ |
    |------|------|-----|
    | **ãƒ—ãƒ­ãƒˆã‚³ãƒ«** | é€šä¿¡ã®æ–¹å¼ | `https://` ã¾ãŸã¯ `http://` |
    | **ãƒ‰ãƒ¡ã‚¤ãƒ³** | ã‚µãƒ¼ãƒãƒ¼ã®ä½æ‰€ | `your-app.run.app` |
    | **ãƒãƒ¼ãƒˆ** | ã‚µãƒ¼ãƒãƒ¼ã®å…¥å£ç•ªå· | `:443`ï¼ˆhttpsï¼‰ã€`:80`ï¼ˆhttpï¼‰â€»çœç•¥å¯ |

    ```
    https://your-app.run.app:443
    â””â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜â””â”¬â”€â”˜
    ãƒ—ãƒ­ãƒˆã‚³ãƒ«   ãƒ‰ãƒ¡ã‚¤ãƒ³    ãƒãƒ¼ãƒˆ
    ```

    **åŒã˜ã‚ªãƒªã‚¸ãƒ³ vs åˆ¥ã‚ªãƒªã‚¸ãƒ³**

    | URL | `https://your-app.run.app` ã¨æ¯”è¼ƒ | ç†ç”± |
    |-----|----------------------------------|------|
    | `https://your-app.run.app/api/chat` | åŒã˜ | ãƒ‘ã‚¹ãŒé•ã†ã ã‘ |
    | `http://your-app.run.app` | **åˆ¥** | ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãŒé•ã† |
    | `https://evil.com` | **åˆ¥** | ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒé•ã† |
    | `https://your-app.run.app:8080` | **åˆ¥** | ãƒãƒ¼ãƒˆãŒé•ã† |

!!! info "httpsã¨httpã®é•ã„"

    | é …ç›® | http | https |
    |------|------|-------|
    | æš—å·åŒ– | ãªã—ï¼ˆä¸¸è¦‹ãˆï¼‰ | ã‚ã‚Šï¼ˆæš—å·åŒ–ï¼‰ |
    | ãƒãƒ¼ãƒˆ | 80 | 443 |
    | å®‰å…¨æ€§ | ä½ã„ | é«˜ã„ |
    | ç”¨é€” | é–‹ç™ºç’°å¢ƒã®ã¿ | æœ¬ç•ªç’°å¢ƒï¼ˆå¿…é ˆï¼‰ |

    ```
    ã€httpã®å ´åˆï¼ˆå±é™ºï¼‰ã€‘
    ã‚ãªãŸ â”€â”€ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: 1234ã€â”€â”€â–¶ ã‚µãƒ¼ãƒãƒ¼
                 â†‘
             èª°ã§ã‚‚è¦‹ã‚Œã‚‹ï¼

    ã€httpsã®å ´åˆï¼ˆå®‰å…¨ï¼‰ã€‘
    ã‚ãªãŸ â”€â”€ã€ŒğŸ”’æš—å·åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã€â”€â”€â–¶ ã‚µãƒ¼ãƒãƒ¼
                 â†‘
             è§£èª­ã§ããªã„
    ```

!!! success "ã‚·ãƒŠãƒªã‚ª1ï¼šæ™®é€šã®ä½¿ã„æ–¹ï¼ˆå•é¡Œãªã—ï¼‰"

    **ã‚ãªãŸã®ã‚µã‚¤ãƒˆ:** `https://your-app.run.app`

    - `front.html`ï¼ˆç”»é¢ï¼‰
    - `/api/chat`ï¼ˆAPIï¼‰

    **æµã‚Œï¼š**
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ your-app.run.app ã«ã‚¢ã‚¯ã‚»ã‚¹ â†’ front.html ã® JavaScript ãŒ `/api/chat` ã‚’å‘¼ã¶ â†’ **åŒã˜ã‚µã‚¤ãƒˆãªã®ã§å•é¡Œãªã— âœ“**

!!! danger "ã‚·ãƒŠãƒªã‚ª2ï¼šæ‚ªæ„ã®ã‚ã‚‹ã‚µã‚¤ãƒˆã‹ã‚‰ã®æ”»æ’ƒ"

    **æ‚ªæ„ã®ã‚ã‚‹ã‚µã‚¤ãƒˆ:** `https://evil.com`

    ãƒšãƒ¼ã‚¸å†…ã®JavaScriptã§ã€ã‚ãªãŸã® `/api/chat` ã‚’å‹æ‰‹ã«å‘¼ã¼ã†ã¨ã™ã‚‹ï¼š

    ```javascript
    fetch('https://your-app.run.app/api/chat', {
        method: 'POST',
        body: JSON.stringify({ message: '...' })
    });
    ```

    **ãƒ–ãƒ©ã‚¦ã‚¶ã®å‹•ãï¼š**

    1. ãƒ–ãƒ©ã‚¦ã‚¶ï¼šã€Œå¾…ã£ã¦ï¼evil.com ã‹ã‚‰ your-app ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã ã€‚è¨±å¯ã•ã‚Œã¦ã‚‹ï¼Ÿã€
    2. ã‚µãƒ¼ãƒãƒ¼ã® `Access-Control-Allow-Origin` ã‚’ç¢ºèª
    3. evil.com ãŒè¨±å¯ã•ã‚Œã¦ã„ãªã‘ã‚Œã° â†’ **ãƒ–ãƒ­ãƒƒã‚¯ï¼**

    **â†’ è¨±å¯ã—ãŸã„å ´åˆã¯ `ALLOWED_ORIGINS` ã«ãã®ã‚ªãƒªã‚¸ãƒ³ã‚’è¿½åŠ ã™ã‚Œã°OKï¼**

    ```python
    # ä¾‹ï¼šãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¼æ¥­ã®ã‚µã‚¤ãƒˆã‹ã‚‰APIã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ãŸã„å ´åˆ
    ALLOWED_ORIGINS = [
        'https://your-app.run.app',      # è‡ªåˆ†ã®ã‚µã‚¤ãƒˆ
        'https://partner-site.com'       # â† ã“ã“ã«è¿½åŠ ï¼
    ]
    ```

**ã¤ã¾ã‚ŠCORSã¯ï¼š**
- ãƒ–ãƒ©ã‚¦ã‚¶ãŒè¡Œã†ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
- ã€Œã“ã®ã‚µã‚¤ãƒˆã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨±å¯ã—ã¾ã™ã‹ï¼Ÿã€ã‚’ã‚µãƒ¼ãƒãƒ¼ã«ç¢ºèª
- ã‚µãƒ¼ãƒãƒ¼ãŒã€ŒOKã€ã¨è¨€ã‚ãªã‘ã‚Œã°ãƒ–ãƒ­ãƒƒã‚¯

!!! info "HTTPãƒ¡ã‚½ãƒƒãƒ‰ã®å½¹å‰²"

    | ãƒ¡ã‚½ãƒƒãƒ‰ | ç”¨é€” | å…·ä½“ä¾‹ |
    |---------|------|--------|
    | **GET** | ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ | ãƒšãƒ¼ã‚¸è¡¨ç¤ºã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾— |
    | **POST** | ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ãƒ»å‡¦ç†ã™ã‚‹ | ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã€ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† |
    | **OPTIONS** | äº‹å‰ç¢ºèªï¼ˆãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆï¼‰ | ã€Œã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ã£ã¦ã„ã„ï¼Ÿã€ã¨ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚µãƒ¼ãƒãƒ¼ã«ç¢ºèª |

    **POSTã®å‹•ãï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰**

    ```
    [ã‚ãªãŸ]                    [APIï¼ˆ+1ã™ã‚‹å‡¦ç†ï¼‰]
       â”‚                              â”‚
       â”‚â”€â”€â”€â”€ POST { value: 1 } â”€â”€â”€â”€â”€â”€â–¶â”‚
       â”‚                              â”‚ â† ã“ã“ã§1+1ã®å‡¦ç†
       â”‚â—€â”€â”€â”€â”€â”€ { result: 2 } â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    ```

    â†’ ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•ã’ã¦ã€APIå´ã§å‡¦ç†ã—ã¦ã€çµæœãŒè¿”ã£ã¦ãã‚‹

!!! note "OPTIONSãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æµã‚Œï¼ˆãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆï¼‰"

    ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã€Œæœ¬ç•ªã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ã‚’é€ã‚‹å‰ã«ã€ã¾ãšã€Œé€ã£ã¦ã„ã„ã‹ï¼Ÿã€ã‚’ç¢ºèªã—ã¾ã™ã€‚

    ```
    ãƒ–ãƒ©ã‚¦ã‚¶: ã€ŒPOSTãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ã‚ŠãŸã„ã‚“ã ã‘ã©ã€ã„ã„ï¼Ÿã€ï¼ˆOPTIONSï¼‰
        â†“
    ã‚µãƒ¼ãƒãƒ¼: ã€Œã“ã®ã‚ªãƒªã‚¸ãƒ³ã‹ã‚‰ãªã‚‰OKã€ã¾ãŸã¯ã€Œãƒ€ãƒ¡ã€
        â†“
    ãƒ–ãƒ©ã‚¦ã‚¶: OKãªã‚‰æœ¬ç•ªã®POSTã‚’é€ä¿¡ã€ãƒ€ãƒ¡ãªã‚‰ãƒ–ãƒ­ãƒƒã‚¯
    ```

    ã“ã®ä»•çµ„ã¿ã«ã‚ˆã‚Šã€è¨±å¯ã•ã‚Œã¦ã„ãªã„ã‚µã‚¤ãƒˆã‹ã‚‰ã®ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é˜²ã„ã§ã„ã¾ã™ã€‚

!!! question "ç™»éŒ²ã™ã‚‹ã‚ªãƒªã‚¸ãƒ³ã®æ›¸ãæ–¹"

    ã‚ªãƒªã‚¸ãƒ³ã¯ã€Œ**ãƒ—ãƒ­ãƒˆã‚³ãƒ« + ãƒ‰ãƒ¡ã‚¤ãƒ³ + ãƒãƒ¼ãƒˆ**ã€ã§ã™ã€‚ãƒ‘ã‚¹ï¼ˆ`/api/chat` ãªã©ï¼‰ã¯å«ã‚ã¾ã›ã‚“ã€‚

    ```
    https://your-app.run.app/page/chat?user=123
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          ã‚ªãƒªã‚¸ãƒ³ï¼ˆã“ã‚Œã‚’ç™»éŒ²ï¼‰    ãƒ‘ã‚¹ï¼ˆå«ã‚ãªã„ï¼‰
    ```

    | ç™»éŒ²ä¾‹ | æ­£èª¤ | ç†ç”± |
    |--------|:----:|------|
    | `https://your-app.run.app` | âœ“ | æ­£ã—ã„å½¢å¼ |
    | `https://your-app.run.app/api/chat` | âœ— | ãƒ‘ã‚¹ã¯ä¸è¦ |
    | `your-app.run.app` | âœ— | ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãŒå¿…è¦ |

    **ä½•ã®ã‚ªãƒªã‚¸ãƒ³ã‚’ç™»éŒ²ã™ã‚‹ï¼Ÿ â†’ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆç”»é¢ï¼‰ã®ã‚ªãƒªã‚¸ãƒ³**

    ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã‚‹ç”»é¢ã®ã‚ªãƒªã‚¸ãƒ³ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

!!! example "è¤‡æ•°ã‚ªãƒªã‚¸ãƒ³ã‚’ç™»éŒ²ã™ã‚‹å ´åˆ"

    é–‹ç™ºç’°å¢ƒãƒ»ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ»æœ¬ç•ªç’°å¢ƒãªã©ã€è¤‡æ•°ã®ã‚ªãƒªã‚¸ãƒ³ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ãªå ´åˆã¯ã€é…åˆ—ã«è¿½åŠ ã—ã¾ã™ã€‚

    ```python
    ALLOWED_ORIGINS = [
        'https://your-app.run.app',           # æœ¬ç•ª
        'https://staging.your-app.run.app',   # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
        'http://localhost:3000',               # é–‹ç™ºï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
        'http://localhost:5173'                # Viteãªã©åˆ¥ãƒãƒ¼ãƒˆ
    ]
    ```

    é–‹ç™ºä¸­ã¯ `['*']` ã§å…¨è¨±å¯ã«ã—ã¦ãŠã„ã¦ã€æœ¬ç•ªã§ã¯å…·ä½“çš„ãªã‚ªãƒªã‚¸ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã€ã¨ã„ã†ã®ãŒã‚ˆãã‚ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚

!!! warning "`['*']`ï¼ˆå…¨è¨±å¯ï¼‰ã®ã¾ã¾ã ã¨ä½•ãŒèµ·ãã‚‹ï¼Ÿ"

    ```python
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼ˆå±é™ºï¼ï¼‰
    ALLOWED_ORIGINS = ['*']  # â† ã©ã“ã‹ã‚‰ã§ã‚‚OK
    ```

    ã“ã®çŠ¶æ…‹ã ã¨ã€**æ‚ªæ„ã®ã‚ã‚‹ã‚µã‚¤ãƒˆã‹ã‚‰APIã‚’å‹æ‰‹ã«ä½¿ã‚ã‚Œã¾ã™**ã€‚

    | è¢«å®³ | å…·ä½“ä¾‹ |
    |------|--------|
    | **èª²é‡‘ãŒç™ºç”Ÿ** | å‹æ‰‹ã«ãƒãƒ£ãƒƒãƒˆAPIã‚’å©ã‹ã‚Œã€OpenAI APIã®æ–™é‡‘ãŒã‚ãªãŸã«è«‹æ±‚ã•ã‚Œã‚‹ |
    | **ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢** | å¤§é‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚µãƒ¼ãƒãƒ¼ãŒãƒ€ã‚¦ãƒ³ã™ã‚‹ |
    | **ä¿¡ç”¨ä½ä¸‹** | ä¸æ­£åˆ©ç”¨ã®è¸ã¿å°ã«ã•ã‚Œã‚‹å¯èƒ½æ€§ |

    **â†’ æœ¬ç•ªã§ã¯å¿…ãšè¨±å¯ã™ã‚‹ã‚ªãƒªã‚¸ãƒ³ã‚’é™å®šã—ã¾ã—ã‚‡ã†ï¼**

---

### 4-2. set_security_headersï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šï¼‰

```python
def set_security_headers(headers):
    headers['X-Content-Type-Options'] = 'nosniff'
    headers['X-Frame-Options'] = 'DENY'
    headers['X-XSS-Protection'] = '1; mode=block'
    headers['Referrer-Policy'] = 'strict-origin-when-cross-origin'
```

#### 1è¡Œãšã¤è§£èª¬

**1. X-Content-Type-Options**
```python
headers['X-Content-Type-Options'] = 'nosniff'
```

!!! warning "æ”»æ’ƒã®ä¾‹"

    æ”»æ’ƒè€…ï¼šã€Œimage.jpgã€ã¨ã„ã†åå‰ã§æ‚ªæ„ã®ã‚ã‚‹JavaScriptã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

    ãƒ–ãƒ©ã‚¦ã‚¶ï¼šã€Œimage.jpg ã£ã¦æ›¸ã„ã¦ã‚ã‚‹ã‘ã©ã€ä¸­èº«ã‚’è¦‹ãŸã‚‰JavaScriptã£ã½ã„ãªã€‚å®Ÿè¡Œã—ã¡ã‚ƒãŠã†ï¼ã€â†’ **æ”»æ’ƒæˆåŠŸï¼**

!!! success "nosniffã®åŠ¹æœ"

    ãƒ–ãƒ©ã‚¦ã‚¶ï¼šã€ŒnosniffãŒè¨­å®šã•ã‚Œã¦ã‚‹ã€‚Content-Typeé€šã‚Šã«è§£é‡ˆã—ã‚ˆã†ã€‚ç”»åƒã¨ã—ã¦æ‰±ã†ã‹ã‚‰å®Ÿè¡Œã—ãªã„ã€â†’ **æ”»æ’ƒå¤±æ•—ï¼**

**2. X-Frame-Options**
```python
headers['X-Frame-Options'] = 'DENY'
```

!!! warning "æ”»æ’ƒã®ä¾‹ï¼šã‚¯ãƒªãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚­ãƒ³ã‚°"

    **æ”»æ’ƒè€…ã®ã‚µã‚¤ãƒˆ evil.com ã®æ‰‹å£ï¼š**

    1. ã€Œç„¡æ–™ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆï¼ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ã€ã¨ã„ã†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    2. ãã®ä¸‹ã«ã€ã‚ãªãŸã®ã‚µã‚¤ãƒˆã‚’iframeã§**é€æ˜**ã«é‡ã­ã¦è¡¨ç¤º
    3. ã€Œãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã€ãƒœã‚¿ãƒ³ã®ä½ç½®ã«ã€ã‚ãªãŸã®ã‚µã‚¤ãƒˆã®ã€Œå‰Šé™¤ã€ãƒœã‚¿ãƒ³ã‚’é…ç½®

    **çµæœï¼š** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Œãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆï¼ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¤ã‚‚ã‚ŠãŒã€å®Ÿéš›ã¯ã€Œå‰Šé™¤ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã„ãŸ

!!! success "DENYã®åŠ¹æœ"

    ã‚ãªãŸã®ã‚µã‚¤ãƒˆã‚’iframeã«åŸ‹ã‚è¾¼ã‚€ã“ã¨ã‚’**ç¦æ­¢** â†’ ã“ã®æ”»æ’ƒãŒä¸å¯èƒ½ã«ãªã‚‹

**3. X-XSS-Protection**
```python
headers['X-XSS-Protection'] = '1; mode=block'
```

!!! warning "æ”»æ’ƒã®ä¾‹ï¼šXSSï¼ˆã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°ï¼‰"

    æ”»æ’ƒè€…ãŒURLã«æ‚ªæ„ã®ã‚ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä»•è¾¼ã‚€ï¼š

    `https://your-app.com/search?q=<script>æ‚ªæ„ã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰</script>`

!!! success "1; mode=blockã®åŠ¹æœ"

    ãƒ–ãƒ©ã‚¦ã‚¶ï¼šã€ŒXSSæ”»æ’ƒã‚’æ¤œçŸ¥ï¼ãƒšãƒ¼ã‚¸ã®è¡¨ç¤ºã‚’ãƒ–ãƒ­ãƒƒã‚¯ã€

    â€» ç¾ä»£ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ç‹¬è‡ªã®XSSå¯¾ç­–ãŒã‚ã‚‹ãŸã‚ã€ã“ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¯è£œåŠ©çš„ãªå½¹å‰²

**4. Referrer-Policy**
```python
headers['Referrer-Policy'] = 'strict-origin-when-cross-origin'
```

!!! info "Referrerï¼ˆãƒªãƒ•ã‚¡ãƒ©ãƒ¼ï¼‰ã¨ã¯"

    ã€Œã©ã®ãƒšãƒ¼ã‚¸ã‹ã‚‰æ¥ãŸã‹ã€ã®æƒ…å ±

    **ä¾‹ï¼š** Aãƒšãƒ¼ã‚¸ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ Bãƒšãƒ¼ã‚¸ã¸ç§»å‹• â†’ Bãƒšãƒ¼ã‚¸ã¯ãƒªãƒ•ã‚¡ãƒ©ãƒ¼ã¨ã—ã¦Aãƒšãƒ¼ã‚¸ã®URLã‚’å—ã‘å–ã‚‹

!!! warning "å•é¡Œ"

    ãƒªãƒ•ã‚¡ãƒ©ãƒ¼ã«ã¯URLã®å…¨ä½“ãŒå«ã¾ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹

    ä¾‹ï¼š`https://your-app.com/user/12345/secret-token`

    â†’ URLã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚„IDãŒå«ã¾ã‚Œã¦ã„ãŸã‚‰**æƒ…å ±æ¼æ´©ï¼**

!!! success "strict-origin-when-cross-originã®åŠ¹æœ"

    | é€ä¿¡å…ˆ | é€ä¿¡å†…å®¹ |
    |--------|----------|
    | åŒã˜ã‚µã‚¤ãƒˆå†… | å®Œå…¨ãªURLé€ä¿¡ |
    | åˆ¥ã‚µã‚¤ãƒˆå®›ã¦ | ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã¿é€ä¿¡ï¼ˆ`https://your-app.com` ã®ã¿ï¼‰ |

---

## 5. ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

### 5-1. is_email_allowedï¼ˆãƒ¡ãƒ¼ãƒ«è¨±å¯ãƒã‚§ãƒƒã‚¯ï¼‰

```python
def is_email_allowed(email):
    if not email:
        return False
    lower_email = email.lower()

    allowed_emails_str = os.environ.get('ALLOWED_EMAILS', '')
    allowed_emails = [e.strip().lower() for e in allowed_emails_str.split(',') if e.strip()]

    allowed_domains_str = os.environ.get('ALLOWED_DOMAINS', '')
    allowed_domains = [d.strip().lower() for d in allowed_domains_str.split(',') if d.strip()]

    if lower_email in allowed_emails:
        return True
    for domain in allowed_domains:
        if lower_email.endswith(domain):
            return True

    if not allowed_emails and not allowed_domains:
        print('âš ï¸ ALLOWED_EMAILS/ALLOWED_DOMAINS æœªè¨­å®š')
        return True
    return False
```

#### 1è¡Œãšã¤è§£èª¬

**1-3è¡Œç›®ï¼šç©ºãƒã‚§ãƒƒã‚¯**
```python
def is_email_allowed(email):
    if not email:
        return False
    lower_email = email.lower()
```

```
email = None or ''ï¼ˆç©ºï¼‰ã®å ´åˆ
  â†’ if not email: ãŒ True
  â†’ return False ã§çµ‚äº†

email = 'Tanaka@Example.com' ã®å ´åˆ
  â†’ lower_email = 'tanaka@example.com' ã«å¤‰æ›
    ï¼ˆå¤§æ–‡å­—å°æ–‡å­—ã‚’çµ±ä¸€ã—ã¦æ¯”è¼ƒã—ã‚„ã™ãã™ã‚‹ï¼‰
```

**4-5è¡Œç›®ï¼šè¨±å¯ãƒ¡ãƒ¼ãƒ«ãƒªã‚¹ãƒˆã®å–å¾—**
```python
allowed_emails_str = os.environ.get('ALLOWED_EMAILS', '')
allowed_emails = [e.strip().lower() for e in allowed_emails_str.split(',') if e.strip()]
```

**è©³ç´°ãªåˆ†è§£**
```python
# ç’°å¢ƒå¤‰æ•°ã®ä¾‹
# ALLOWED_EMAILS = "tanaka@example.com, yamada@test.com, admin@company.co.jp"

# ã‚¹ãƒ†ãƒƒãƒ—1: ç’°å¢ƒå¤‰æ•°ã‚’å–å¾—
allowed_emails_str = os.environ.get('ALLOWED_EMAILS', '')
# â†’ "tanaka@example.com, yamada@test.com, admin@company.co.jp"
# ï¼ˆã‚‚ã—ç’°å¢ƒå¤‰æ•°ãŒãªã‘ã‚Œã°ç©ºæ–‡å­— '' ã«ãªã‚‹ï¼‰

# ã‚¹ãƒ†ãƒƒãƒ—2: ã‚«ãƒ³ãƒã§åˆ†å‰²
parts = allowed_emails_str.split(',')
# â†’ ["tanaka@example.com", " yamada@test.com", " admin@company.co.jp"]
#    â€» ç©ºç™½ãŒæ®‹ã£ã¦ã„ã‚‹

# ã‚¹ãƒ†ãƒƒãƒ—3: å„è¦ç´ ã‚’å‡¦ç†
allowed_emails = []
for e in parts:
    cleaned = e.strip()       # å‰å¾Œã®ç©ºç™½ã‚’é™¤å»
    if cleaned:               # ç©ºã§ãªã‘ã‚Œã°
        allowed_emails.append(cleaned.lower())  # å°æ–‡å­—ã«ã—ã¦è¿½åŠ 

# çµæœ
# â†’ ["tanaka@example.com", "yamada@test.com", "admin@company.co.jp"]
```

**ãƒªã‚¹ãƒˆå†…åŒ…è¡¨è¨˜ã®èª­ã¿æ–¹**
```python
[e.strip().lower() for e in allowed_emails_str.split(',') if e.strip()]
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    ã€Œä½•ã‚’ã™ã‚‹ã€         ã€Œä½•ã‹ã‚‰ç¹°ã‚Šè¿”ã™ã€              ã€Œæ¡ä»¶ã€
```

**8-11è¡Œç›®ï¼šè¨±å¯ãƒã‚§ãƒƒã‚¯**
```python
if lower_email in allowed_emails:
    return True
for domain in allowed_domains:
    if lower_email.endswith(domain):
        return True
```

```
ãƒã‚§ãƒƒã‚¯1: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¨±å¯ãƒªã‚¹ãƒˆã«å®Œå…¨ä¸€è‡´ã™ã‚‹ã‹
  ä¾‹: tanaka@example.com in ["tanaka@example.com", "yamada@test.com"]
  â†’ True

ãƒã‚§ãƒƒã‚¯2: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¨±å¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã§çµ‚ã‚ã‚‹ã‹
  ä¾‹: "tanaka@company.co.jp".endswith("@company.co.jp")
  â†’ Trueï¼ˆä¼šç¤¾ã®ãƒ‰ãƒ¡ã‚¤ãƒ³å…¨å“¡ã‚’è¨±å¯ã™ã‚‹å ´åˆã«ä½¿ã†ï¼‰
```

---

### 5-2. get_email_from_tokenï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ãƒ¡ãƒ¼ãƒ«å–å¾—ï¼‰

```python
def get_email_from_token(id_token):
    try:
        payload = id_token.split('.')[1]
        padding = 4 - len(payload) % 4
        if padding != 4:
            payload += '=' * padding
        decoded = base64.urlsafe_b64decode(payload).decode('utf-8')
        return json.loads(decoded).get('email')
    except:
        return None
```

#### å®Œå…¨ãªå‡¦ç†ã®æµã‚Œ

```python
# å…¥åŠ›ã•ã‚Œã‚‹JWTãƒˆãƒ¼ã‚¯ãƒ³ã®ä¾‹
id_token = "eyJhbGciOiJSUzI1NiJ9.eyJlbWFpbCI6InRhbmFrYUBleGFtcGxlLmNvbSJ9.abc123"

# ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ”ãƒªã‚ªãƒ‰ã§åˆ†å‰²
parts = id_token.split('.')
# â†’ ["eyJhbGciOiJSUzI1NiJ9", "eyJlbWFpbCI6InRhbmFrYUBleGFtcGxlLmNvbSJ9", "abc123"]
#         ãƒ˜ãƒƒãƒ€ãƒ¼                      ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰                      ç½²å

# ã‚¹ãƒ†ãƒƒãƒ—2: ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ï¼ˆ2ç•ªç›®ï¼‰ã‚’å–å¾—
payload = parts[1]
# â†’ "eyJlbWFpbCI6InRhbmFrYUBleGFtcGxlLmNvbSJ9"

# ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°èª¿æ•´ï¼ˆBase64ã®ä»•æ§˜ã«åˆã‚ã›ã‚‹ï¼‰
# Base64ã¯4æ–‡å­—ãšã¤å‡¦ç†ã™ã‚‹ã®ã§ã€4ã®å€æ•°ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
padding = 4 - len(payload) % 4  # ä½•æ–‡å­—è¶³ã‚Šãªã„ã‹
if padding != 4:
    payload += '=' * padding  # '='ã§åŸ‹ã‚ã‚‹

# ã‚¹ãƒ†ãƒƒãƒ—4: Base64ãƒ‡ã‚³ãƒ¼ãƒ‰
decoded_bytes = base64.urlsafe_b64decode(payload)
# â†’ b'{"email":"tanaka@example.com"}'

# ã‚¹ãƒ†ãƒƒãƒ—5: ãƒã‚¤ãƒˆåˆ—ã‚’æ–‡å­—åˆ—ã«å¤‰æ›
decoded_str = decoded_bytes.decode('utf-8')
# â†’ '{"email":"tanaka@example.com"}'

# ã‚¹ãƒ†ãƒƒãƒ—6: JSONæ–‡å­—åˆ—ã‚’è¾æ›¸ã«å¤‰æ›
data = json.loads(decoded_str)
# â†’ {"email": "tanaka@example.com"}

# ã‚¹ãƒ†ãƒƒãƒ—7: emailã‚’å–å¾—
email = data.get('email')
# â†’ "tanaka@example.com"
```

**å›³è§£**
```
JWTãƒˆãƒ¼ã‚¯ãƒ³
eyJhbGci...  .  eyJlbWFpbCI...  .  SflKxwRJ...
     |               |               |
  ãƒ˜ãƒƒãƒ€ãƒ¼       ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰        ç½²å
                     â†“
            split('.')[1]ã§å–å¾—
                     â†“
        eyJlbWFpbCI6InRhbmFrYUBleGFtcGxlLmNvbSJ9
                     â†“
            Base64ãƒ‡ã‚³ãƒ¼ãƒ‰
                     â†“
        {"email":"tanaka@example.com"}
                     â†“
            json.loads()ã§è¾æ›¸ã«
                     â†“
            .get('email')ã§å–å¾—
                     â†“
            tanaka@example.com
```

---

## 6. ãƒ¡ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒ©

### 6-1. ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã®å®šç¾©

```python
@functions_framework.http
def app(request):
```

!!! note "@ ã¨ã¯ï¼Ÿï¼ˆãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ï¼‰"

    ```python
    @functions_framework.http
    def app(request):
    ```

    ã€Œapp ã¨ã„ã†é–¢æ•°ã‚’ã€HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚‹é–¢æ•°ã¨ã—ã¦Cloud Run ã«ç™»éŒ²ã™ã‚‹ã€ã¨ã„ã†æ„å‘³

    **@ï¼ˆã‚¢ãƒƒãƒˆãƒãƒ¼ã‚¯ï¼‰= é–¢æ•°ã«ç›®å°ã‚’ã¤ã‘ã‚‹ä»•çµ„ã¿**

    | å½¹å‰² | èª¬æ˜ |
    |------|------|
    | Cloud Run | ã€Œå—ä»˜ä¿‚å‹Ÿé›†ä¸­ã€ |
    | `def app(request):` | ã€Œã¯ã„ï¼ç§ãŒå—ä»˜ä¿‚ã§ã™ï¼ã€ |
    | `@functions_framework.http` | ã€Œã“ã®äººã‚’å—ä»˜ä¿‚ã¨ã—ã¦ç™»éŒ²ã—ã¦ãã ã•ã„ã€ |

### 6-2. requestã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

```python
def app(request):
    # request = ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰å±Šã„ãŸæƒ…å ±å…¨éƒ¨
```

| ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ | èª¬æ˜ | ä¾‹ |
|-----------|------|-----|
| `request.method` | HTTPãƒ¡ã‚½ãƒƒãƒ‰ | `'GET'`, `'POST'` |
| `request.path` | URLã®ãƒ‘ã‚¹ | `'/'`, `'/api/chat'` |
| `request.headers` | ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ± | `{'Authorization': 'Bearer xxx'}` |
| `request.get_json()` | ãƒœãƒ‡ã‚£ï¼ˆJSONï¼‰ | `{'message': 'ã“ã‚“ã«ã¡ã¯'}` |

### 6-3. æˆ»ã‚Šå€¤

```python
return (HTML_CONTENT, 200, headers)
#         â†‘          â†‘      â†‘
#       æœ¬æ–‡     ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹  ãƒ˜ãƒƒãƒ€ãƒ¼
```

| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ | æ„å‘³ |
|-----------------|------|
| `200` | æˆåŠŸ |
| `400` | ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä¸æ­£ï¼ˆå…¥åŠ›ã‚¨ãƒ©ãƒ¼ï¼‰ |
| `401` | èªè¨¼ãŒå¿…è¦ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„ï¼‰ |
| `403` | æ¨©é™ãªã—ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã ãŒè¨±å¯ã•ã‚Œã¦ã„ãªã„ï¼‰ |
| `404` | ãƒšãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚‰ãªã„ |
| `500` | ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ |

---

## ã¾ã¨ã‚

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§å­¦ã‚“ã Pythonæ§‹æ–‡ï¼š

| æ§‹æ–‡ | æ„å‘³ | ä¾‹ |
|------|------|-----|
| `dict['key'] = value` | è¾æ›¸ã«å€¤ã‚’è¿½åŠ  | `headers['Content-Type'] = 'text/html'` |
| `x in list` | ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã‚‹ã‹ | `'*' in ALLOWED_ORIGINS` |
| `a or b` | aãŒã‚ã‚Œã°aã€ãªã‘ã‚Œã°b | `origin or '*'` |
| `with open() as f:` | ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®‰å…¨ã«é–‹ã | ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ |
| `base64.decode()` | Base64ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ | ãƒˆãƒ¼ã‚¯ãƒ³è§£æ |
| `@decorator` | é–¢æ•°ã«ç›®å°ã‚’ã¤ã‘ã‚‹ | `@functions_framework.http` |
| `[x for x in list]` | ãƒªã‚¹ãƒˆå†…åŒ…è¡¨è¨˜ | ãƒ¡ãƒ¼ãƒ«ãƒªã‚¹ãƒˆã®å‡¦ç† |
