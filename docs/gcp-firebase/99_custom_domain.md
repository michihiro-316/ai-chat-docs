# カスタムドメイン設定（本番環境向け）

> この資料は本番環境で独自ドメインを使用する場合の手順です。
> テスト環境ではCloud Runのデフォルトドメインを使用するため、この手順は不要です。

---

## Cloud Runのデフォルトドメインについて

Cloud Run functionsをデプロイすると、以下のようなURLが自動で割り当てられます。

```
https://[サービス名]-[ランダム文字列]-[リージョン].a.run.app
例: https://ai-chat-app-198203881336.asia-northeast1.run.app
```

このURLはそのまま使用できますが、本番環境では覚えやすい独自ドメイン（例: `chat.yourcompany.com`）を設定することを推奨します。

---

## Firebaseのデフォルトドメインについて

テスト環境で使用するデフォルトドメインには2種類あります。

| ドメイン | 説明 |
|---------|------|
| `project-id.web.app` | 新しい形式。**こちらを使用推奨** |
| `project-id.firebaseapp.com` | 旧形式。互換性のために残されている |

どちらも同じコンテンツを表示します。機能的な違いはありません。
`web.app` の方が短くて覚えやすいため、テスト環境では `web.app` を使用してください。

**カスタムドメインを設定する場合、これらのデフォルトドメインも引き続き有効です。**
カスタムドメイン設定後も `project-id.web.app` でアクセス可能です。

---

## 前提条件

- 独自ドメインを取得済み（例: `example.com`）
- ドメインのDNS設定を変更できる権限がある

---

## 全体像

```
ユーザー
   |
   | https://app.example.com（フロントエンド）
   v
Firebase Hosting ← カスタムドメイン設定
   |
   | APIリクエスト
   | https://api.example.com（バックエンド）
   v
Cloud Run ← ドメインマッピング設定
```

| 用途 | デフォルトURL | カスタムドメイン例 |
|------|--------------|-------------------|
| フロントエンド | `project-id.web.app` | `app.example.com` |
| バックエンド | `service-xxx.run.app` | `api.example.com` |

---

## Step 1: Cloud Runのカスタムドメイン設定

### 1-1. ドメインマッピングの追加

1. GCPコンソール →「Cloud Run」→ 対象のサービスをクリック
2. 「ドメインマッピング」タブ →「マッピングを追加」
3. 「Cloud Runドメインマッピングを使用」を選択
4. ドメイン: `api.example.com`（サブドメイン推奨）
5. 「続行」

### 1-2. DNS設定

表示されるDNSレコード情報をメモし、ドメインのDNS設定画面で追加します。

| レコードタイプ | ホスト名 | 値 |
|--------------|---------|-----|
| CNAME | `api` | `ghs.googlehosted.com.` |

> **注意**: CNAMEレコードの値の末尾にピリオド（`.`）が必要な場合があります（DNS事業者による）

### 1-3. SSL証明書の発行待ち

- ドメインマッピング後、GoogleがSSL証明書を自動発行します
- 通常15〜30分程度かかります
- 証明書発行完了後、`https://api.example.com` でアクセス可能になります

### 1-4. 確認方法

```
ステータス確認:
GCPコンソール → Cloud Run → ドメインマッピング
→ 緑のチェックマークが表示されれば完了
```

---

## Step 2: Firebase Hostingのカスタムドメイン設定

### 2-1. カスタムドメインの追加

1. Firebaseコンソール →「Hosting」→「カスタムドメインを追加」
2. ドメイン: `app.example.com`
3. 「続行」

### 2-2. ドメイン所有権の確認

Firebaseが表示するTXTレコードをDNSに追加して所有権を確認します。

| レコードタイプ | ホスト名 | 値 |
|--------------|---------|-----|
| TXT | `app` | `firebase=xxxxxxxxxxxx`（表示された値） |

### 2-3. DNS設定

所有権確認後、以下のレコードを追加します。

| レコードタイプ | ホスト名 | 値 |
|--------------|---------|-----|
| A | `app` | `151.101.1.195` |
| A | `app` | `151.101.65.195` |

> **注意**: IPアドレスはFirebaseコンソールに表示される値を使用してください（変更される可能性があります）

### 2-4. SSL証明書の発行待ち

- Firebase Hostingも自動でSSL証明書を発行します
- 通常数時間〜24時間程度かかる場合があります

---

## Step 3: Firebase認証済みドメインの更新（重要）

カスタムドメインでGoogleログインを使用するには、**必ず承認済みドメインへの追加が必要**です。

### なぜ必要か？

Firebase Authenticationはセキュリティ上の理由から、OAuth認証（Googleログイン等）を許可するドメインを制限しています。これは「オープンリダイレクト攻撃」を防ぐためです。

```
【承認済みドメインがないと起こること】

ユーザー: カスタムドメイン（chat.example.com）でログイン
    ↓
Firebase: 「このドメインは許可リストにない！」
    ↓
エラー: 「auth/unauthorized-domain」
    ↓
ログインできない
```

### 設定手順

1. Firebaseコンソール → **Authentication** → **Settings**
2. **「承認済みドメイン」** タブをクリック
3. **「ドメインを追加」** をクリック
4. カスタムドメインを入力（`https://` は含めない）:
   ```
   chat.example.com
   ```
5. 「追加」をクリック

### 複数ドメインを使う場合

フロントエンドとAPIで異なるドメインを使う場合は、**フロントエンドのドメインのみ追加**すればOKです。

| ドメイン | 用途 | 承認済みドメインへの追加 |
|---------|------|:----------------------:|
| `chat.example.com` | フロントエンド（ログイン画面） | ✓ 必要 |
| `api.example.com` | バックエンドAPI | 不要 |

> **注意**: カスタムドメイン設定後も、元のCloud Run URLでアクセス可能です。
> 両方のドメインでログインを許可したい場合は、両方とも承認済みドメインに追加してください。

---

## DNS設定まとめ

最終的なDNS設定は以下のようになります。

| レコードタイプ | ホスト名 | 値 | 用途 |
|--------------|---------|-----|------|
| TXT | `app` | `firebase=xxxx` | Firebase所有権確認 |
| A | `app` | `151.101.1.195` | Firebase Hosting |
| A | `app` | `151.101.65.195` | Firebase Hosting |
| CNAME | `api` | `ghs.googlehosted.com.` | Cloud Run |

---

## 反映確認

### DNSの反映確認

DNSチェッカーで設定が反映されているか確認できます。

- https://www.whatsmydns.net

1. ドメイン名を入力（例: `api.example.com`）
2. レコードタイプを選択（CNAME または A）
3. 「Search」をクリック
4. 世界各地のDNSサーバーで反映状況を確認

> **注意**: DNS反映には最大48時間かかる場合があります（通常は数時間以内）

### 接続確認

| 確認項目 | URL | 期待する結果 |
|---------|-----|-------------|
| フロントエンド | `https://app.example.com` | アプリ画面が表示 |
| バックエンド | `https://api.example.com` | API応答 or Hello World |
| HTTPS | 両方 | ブラウザに鍵マークが表示 |

---

## トラブルシューティング

### SSL証明書が発行されない

**症状**: 数時間経っても「証明書のプロビジョニング中」のまま

**原因と対処**:
- DNSレコードが正しく設定されていない → DNS設定を再確認
- DNSが反映されていない → whatsmydns.net で確認、数時間待つ
- CAAレコードが制限している → CAAレコードがあれば削除または許可設定

### 「このサイトにアクセスできません」

**原因と対処**:
- DNS設定が反映されていない → 数時間待つ
- DNSレコードの値が間違っている → コンソールの表示値と比較
- ドメインの有効期限切れ → ドメイン管理画面で確認

### Googleログインできない

**原因と対処**:
- 承認済みドメインに追加していない → Firebase Authentication → Settings で追加
- `http://` でアクセスしている → `https://` を使用

---

## フロントエンドコードの変更

カスタムドメインを使用する場合、フロントエンドのAPI呼び出し先を変更します。

```javascript
// 変更前（デフォルトURL）
const API_URL = 'https://ai-platform-tenant-a-xxxxx.run.app';

// 変更後（カスタムドメイン）
const API_URL = 'https://api.example.com';
```

---

## 参考: サブドメイン vs ルートドメイン

| 設定 | 例 | 推奨 |
|------|-----|------|
| サブドメイン | `app.example.com`, `api.example.com` | 推奨 |
| ルートドメイン | `example.com` | 設定が複雑になる場合あり |

サブドメインを使用する理由:
- CNAMEレコードが使える（ルートドメインでは使えない場合がある）
- 用途ごとに分離できる（`app.`, `api.`, `admin.` など）
- 将来的な拡張がしやすい
