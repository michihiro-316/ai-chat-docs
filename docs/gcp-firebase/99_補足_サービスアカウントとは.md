# サービスアカウントとは（補足資料）

> この資料は「Cloud Run（サービス）版」で使用するサービスアカウントの解説です。
> Cloud Run functions版（02_構築手順書.md）では、サービスアカウントを明示的に作成する必要はありません（デフォルトのサービスアカウントを使用）。

---

## サービスアカウントを一言で

**アプリ専用のGoogleアカウント** です。

---

## 人間のアカウントとの違い

| 項目 | 人間のアカウント | サービスアカウント |
|------|-----------------|-------------------|
| 使う人 | あなた（人間） | アプリ（プログラム） |
| ログイン | メール + パスワード | 自動（キーファイル等） |
| 例 | `tanaka@gmail.com` | `sa-tenant-a@project-id.iam.gserviceaccount.com` |
| 用途 | GCPコンソールにログイン | アプリがGCPサービスを利用 |

---

## なぜサービスアカウントが必要なのか

### 問題: アプリがGCPサービスを使いたい

```
Cloud Run（アプリ）が Secret Manager（APIキー保管庫）にアクセスしたい

でも...
・アプリは人間じゃないからGoogleアカウントでログインできない
・かといって誰でもアクセスできたらセキュリティ的に危険
```

### 解決: サービスアカウント

```
サービスアカウントを作成
    ↓
「このアカウントはSecret Managerを読んでいいよ」と権限を付与
    ↓
Cloud Runに「このサービスアカウントを使ってね」と設定
    ↓
Cloud RunがSecret Managerにアクセスできるようになる！
```

---

## 身近な例えで理解する

### 例1: 会社の入館証

```
人間のアカウント = 社員証（あなた専用）
サービスアカウント = 業者用の入館証（配送ロボット用）

配送ロボットに「倉庫エリアだけ入れる入館証」を渡す
→ ロボットは倉庫にはアクセスできるが、オフィスには入れない
```

### 例2: 銀行の代理人

```
あなた = 銀行口座の持ち主
サービスアカウント = 委任状を持った代理人

「この代理人は残高照会だけできます」と限定した権限を与える
→ 代理人は残高は見れるが、引き出しはできない
```

---

## Cloud Run（サービス）版での使い方

```
+------------------------------------------------------------------+
|                        GCPプロジェクト                            |
|                                                                  |
|  +-------------------+           +-------------------------+     |
|  | Cloud Run         |           | Secret Manager          |     |
|  | (サービス)        |  アクセス  | (APIキー保管庫)          |     |
|  |                   | --------> |                         |     |
|  | サービスアカウント: |           | tenant-a-openai-key     |     |
|  | sa-tenant-a       |           |                         |     |
|  +-------------------+           | アクセス許可:            |     |
|                                  | sa-tenant-a [OK]        |     |
|                                  +-------------------------+     |
+------------------------------------------------------------------+
```

1. **サービスアカウント作成**: `sa-tenant-a` という名前で作成
2. **権限付与**: Secret Managerの特定のシークレットに対して「読み取り権限」を付与
3. **Cloud Runサービスに設定**: Cloud Runがこのサービスアカウントを使うように設定
4. **アクセス成功**: Cloud RunがAPIキーを取得できるようになる

> **Cloud Run functions版との違い**
> Cloud Run functions版では、デフォルトのサービスアカウントが使用されます。
> 関数作成時に「シークレットを参照」からシークレットを紐付けるだけでOKです。

---

## サービスアカウントのメリット

### 1. 最小権限の原則

```
悪い例:
アプリに管理者権限を与える → 何でもできてしまう（危険）

良い例:
サービスアカウントに必要最小限の権限だけ与える
→ 「Secret Managerの読み取りだけ」など限定できる
```

### 2. 監査ログ

```
誰が（どのサービスアカウントが）
いつ
何にアクセスしたか

すべて記録される → 問題が起きた時に追跡可能
```

### 3. 権限の分離

```
テナントA用: sa-tenant-a → tenant-a-openai-key にだけアクセス可能
テナントB用: sa-tenant-b → tenant-b-openai-key にだけアクセス可能

互いのデータにはアクセスできない → セキュリティ向上
```

---

## よくある質問

### Q: サービスアカウントは必ず作る必要がある？

**A: 必須ではないが、推奨です。**

サービスアカウントを作らない場合、Cloud Runはデフォルトのサービスアカウントを使います。
ただしデフォルトは権限が広すぎることが多く、セキュリティ上は専用のサービスアカウントを作る方が安全です。

### Q: サービスアカウントに料金はかかる？

**A: サービスアカウント自体は無料です。**

サービスアカウントを作成・使用すること自体には料金はかかりません。
料金がかかるのは、そのサービスアカウントを使ってアクセスするGCPサービス（Cloud Run、Secret Manager等）の利用料金です。

### Q: 1つのサービスアカウントを複数のサービスで使い回してもいい？

**A: 可能ですが、分けた方がセキュリティ的に安全です。**

```
使い回す場合:
Cloud Run A ──┐
              ├── sa-shared ── すべてのシークレットにアクセス可能
Cloud Run B ──┘

分ける場合:
Cloud Run A ── sa-tenant-a ── tenant-a のシークレットのみ
Cloud Run B ── sa-tenant-b ── tenant-b のシークレットのみ
```

---

## まとめ

| 項目 | 説明 |
|------|------|
| サービスアカウントとは | アプリ専用のGoogleアカウント |
| なぜ必要か | アプリがGCPサービスにアクセスするため |
| メリット | 最小権限、監査ログ、権限分離 |
| Cloud Run（サービス）版 | サービスアカウントを作成して権限付与 |
| Cloud Run functions版 | デフォルトSAを使用、シークレットを直接紐付け |
