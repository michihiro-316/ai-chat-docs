# コード解説（初心者向け）

このセクションでは、AIチャットアプリのコードを**一行ずつ丁寧に**解説します。

---

## このドキュメントの目的

- プログラミング初心者でも理解できるように説明
- 各ファイルの役割と関連を明確にする
- なぜそのコードが必要なのかを説明する

---

## ファイル構成

```
python/
├── backend.py      ← サーバー側の処理（受付係）
├── front.html      ← 画面の構造（見た目）
├── script.js       ← 画面の動き（操作）
└── requirements.txt ← 必要なライブラリ一覧
```

---

## 全体像：レストランに例えると

```
┌─────────────────────────────────────────────────────────────────┐
│                    【レストラン = Webアプリ】                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   front.html = 店内の装飾、テーブル配置                          │
│   ┌──────────────────────────────────────────────┐              │
│   │  メニュー表、椅子、テーブル、照明              │              │
│   │  → 見た目を決める。動かない。                 │              │
│   └──────────────────────────────────────────────┘              │
│                         ↓ お客さんが操作                        │
│   script.js = ウェイター                                        │
│   ┌──────────────────────────────────────────────┐              │
│   │  お客さんの注文を聞く                         │              │
│   │  厨房に注文を伝える                           │              │
│   │  料理をテーブルに運ぶ                         │              │
│   └──────────────────────────────────────────────┘              │
│                         ↓ 注文を伝える                          │
│   backend.py = 厨房のシェフ                                     │
│   ┌──────────────────────────────────────────────┐              │
│   │  注文を受け取る                               │              │
│   │  料理を作る（AI API呼び出し）                 │              │
│   │  完成した料理を返す                           │              │
│   └──────────────────────────────────────────────┘              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 処理の流れ（時系列）

```
【ユーザーがチャットするまでの流れ】

1. ユーザーがURLにアクセス
   ↓
2. Cloud Run: 「/ へのGETリクエストだな」
   ↓
3. backend.py: front.html の内容を返す
   ↓
4. ブラウザ: HTML を解釈、script.js を読み込む
   ↓
5. script.js: Firebase 認証を初期化
   ↓
6. ログイン画面が表示される
   ↓
7. ユーザー: 「Googleでログイン」ボタンをクリック
   ↓
8. script.js: Google認証ポップアップを表示
   ↓
9. ユーザー: Googleアカウントを選択
   ↓
10. Firebase: ログイン成功、JWTトークン発行
    ↓
11. script.js: /api/check-access にトークンを送信
    ↓
12. backend.py: トークンからメールアドレスを取得
    ↓
13. backend.py: ALLOWED_EMAILS に含まれるか確認
    ↓
14. 許可されていれば → チャット画面を表示
    ↓
15. ユーザー: メッセージを入力して送信
    ↓
16. script.js: /api/chat にメッセージを送信
    ↓
17. backend.py: OpenAI API を呼び出し
    ↓
18. backend.py: AIの回答を返す
    ↓
19. script.js: 回答を画面に表示
```

---

## 各ファイルの詳細解説

| ファイル | 解説ページ | 役割 |
|---------|-----------|------|
| [backend.py](01_backend.md) | サーバー側処理 | リクエストを受け取り、処理して返す |
| [front.html](02_front.md) | 画面構造 | 見た目を定義する（静的） |
| [script.js](03_script.md) | 画面の動き | ユーザー操作を処理する |
| [エントリポイント](04_entrypoint.md) | 仕組み解説 | なぜ `app` を指定するのか |

---

## 用語集

| 用語 | 説明 | 例え |
|------|------|------|
| リクエスト | ブラウザからサーバーへの要求 | 「注文」 |
| レスポンス | サーバーからブラウザへの返答 | 「料理を出す」 |
| API | サーバーが提供する機能の窓口 | 「メニュー」 |
| JWT トークン | ログイン証明書 | 「会員証」 |
| 関数 | 処理をまとめたもの | 「レシピ」 |
| 引数 | 関数に渡す情報 | 「材料」 |
| 戻り値 | 関数から返ってくる結果 | 「完成した料理」 |
